<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Design Workboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            user-select: none; /* Prevent text selection while dragging */
        }
        
        /* Grid Background */
        #canvas-container {
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            transition: background-position 0.05s ease;
        }

        /* Scrollbar hiding for internal elements */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Syntax Highlighting Mock */
        .code-block {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.75rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
            user-select: text;
            cursor: text;
        }
        
        /* Make modal content selectable */
        #expand-modal-content,
        #expand-modal-content * {
            user-select: text !important;
        }
        
        /* Smooth transitions for tabs */
        .tab-content {
            animation: fadeIn 0.2s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Dragging visuals */
        .dragging-row {
            opacity: 0.4;
            background-color: #f1f5f9;
            border: 2px dashed #94a3b8;
        }

        .table-card {
            will-change: transform;
        }

        .dragging-table {
            transition: none !important;
            will-change: transform;
        }

        /* Connection Animation */
        .connection-line {
            stroke-dasharray: 10, 5;
            animation: flow 60s linear infinite; /* Very slow flow */
            transition: stroke 0.2s ease;
        }
        .connection-line:hover,
        .connection-line.connection-line-hover {
            stroke: #6366f1 !important;
            stroke-width: 3;
        }
        .connection-line.selected {
            stroke: #6366f1 !important;
            stroke-width: 3;
        }
        .connection-line-active {
            stroke-dasharray: 8, 4;
            animation: flow 1s linear infinite; /* Fast flow for active creation */
        }
        
        @keyframes flow {
            to {
                stroke-dashoffset: -1000;
            }
        }

        /* Badge Styles */
        .relation-badge {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .relation-badge:hover {
            transform: scale(1.1);
            z-index: 50;
        }
        .relation-badge.badge-hover {
            background-color: #6366f1 !important;
            color: white !important;
            border-color: #6366f1 !important;
        }
        .relation-badge.badge-selected {
            background-color: #6366f1 !important;
            color: white !important;
            border-color: #4f46e5 !important;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 w-screen h-screen relative">

    <!-- Hidden Inputs -->
    <input type="file" id="import-file" accept=".json" class="hidden" onchange="app.handleFileSelect(event)">

    <!-- UI Layer: Toolbar (Left) -->
    <div id="left-toolbar" class="absolute top-4 left-4 z-50 flex flex-col gap-2 transition-opacity duration-300">
        <div class="bg-white shadow-lg rounded-xl p-2 border border-slate-200 flex flex-col gap-2">
            <div class="p-2 bg-indigo-600 text-white rounded-lg flex items-center justify-center shadow-md">
                <i data-lucide="database" class="w-6 h-6"></i>
            </div>
            <div class="h-px bg-slate-200 my-1"></div>
            
            <button onclick="app.openModal()" class="p-3 hover:bg-slate-100 rounded-lg text-slate-600 transition-colors tooltip-container group relative" title="Add Table">
                <i data-lucide="plus" class="w-6 h-6"></i>
                <span class="absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity whitespace-nowrap">Add Table</span>
            </button>
            
            <button onclick="app.autoLayout()" class="p-3 hover:bg-slate-100 rounded-lg text-slate-600 transition-colors group relative" title="Beautify Layout">
                <i data-lucide="sparkles" class="w-6 h-6 text-amber-500"></i>
                <span class="absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity whitespace-nowrap">Beautify</span>
            </button>

            <button onclick="app.resetView()" class="p-3 hover:bg-slate-100 rounded-lg text-slate-600 transition-colors group relative" title="Reset View">
                <i data-lucide="move" class="w-6 h-6"></i>
                <span class="absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity whitespace-nowrap">Reset View</span>
            </button>

            <div class="h-px bg-slate-200 my-1"></div>

            <button onclick="app.exportSchema()" class="p-3 hover:bg-slate-100 rounded-lg text-slate-600 transition-colors group relative" title="Export JSON">
                <i data-lucide="download" class="w-6 h-6"></i>
                <span class="absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity whitespace-nowrap">Export</span>
            </button>

            <button onclick="app.triggerImport()" class="p-3 hover:bg-slate-100 rounded-lg text-slate-600 transition-colors group relative" title="Import JSON">
                <i data-lucide="upload" class="w-6 h-6"></i>
                <span class="absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity whitespace-nowrap">Import</span>
            </button>

            <button onclick="app.exportPDF()" class="p-3 hover:bg-slate-100 rounded-lg text-slate-600 transition-colors group relative" title="Export PDF">
                <i data-lucide="file-text" class="w-6 h-6 text-red-500"></i>
                <span class="absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity whitespace-nowrap">Export PDF</span>
            </button>

            <div class="h-px bg-slate-200 my-1"></div>

            <button onclick="app.requestClear()" class="p-3 hover:bg-rose-50 rounded-lg text-rose-500 transition-colors group relative" title="Clear Board">
                <i data-lucide="trash-2" class="w-6 h-6"></i>
                <span class="absolute left-full ml-2 top-1/2 -translate-y-1/2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity whitespace-nowrap">Clear All</span>
            </button>

            <div class="h-px bg-slate-200 my-1"></div>

            <button onclick="app.zoomIn()" class="p-3 hover:bg-slate-100 rounded-lg text-slate-600 transition-colors group relative">
                <i data-lucide="zoom-in" class="w-6 h-6"></i>
            </button>
            <button onclick="app.zoomOut()" class="p-3 hover:bg-slate-100 rounded-lg text-slate-600 transition-colors group relative">
                <i data-lucide="zoom-out" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <!-- UI Layer: Top Right View Toggle and Search -->
    <div class="absolute top-4 right-4 z-50 flex items-center gap-3">
        <!-- Search Bar -->
        <div class="relative">
            <div class="relative">
                <input 
                    type="text" 
                    id="table-search" 
                    placeholder="Search tables..." 
                    oninput="app.handleSearch(this.value)"
                    onfocus="app.showSearchSuggestions()"
                    onblur="setTimeout(() => app.hideSearchSuggestions(), 200)"
                    class="w-64 px-3 py-1.5 pl-9 pr-8 text-sm bg-white border border-slate-200 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all"
                >
                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none"></i>
                <button 
                    onclick="app.clearSearch()" 
                    id="clear-search-btn"
                    class="hidden absolute right-2 top-1/2 -translate-y-1/2 p-0.5 rounded hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors"
                >
                    <i data-lucide="x" class="w-3.5 h-3.5"></i>
                </button>
            </div>
            <!-- Search Suggestions Dropdown -->
            <div 
                id="search-suggestions" 
                class="hidden absolute top-full mt-2 w-full bg-white border border-slate-200 rounded-lg shadow-xl max-h-80 overflow-y-auto z-50"
            >
                <div id="suggestions-list" class="py-1">
                    <!-- Suggestions will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- View Toggle -->
        <div class="bg-white p-1 rounded-lg shadow-md border border-slate-200 flex text-sm font-medium">
            <button onclick="app.switchView('board')" id="btn-view-board" class="px-3 py-1.5 rounded-md bg-indigo-50 text-indigo-600 shadow-sm transition-all flex items-center gap-2">
                <i data-lucide="layout-grid" class="w-4 h-4"></i> Board
            </button>
            <button onclick="app.switchView('list')" id="btn-view-list" class="px-3 py-1.5 rounded-md text-slate-500 hover:bg-slate-50 transition-all flex items-center gap-2">
                <i data-lucide="list" class="w-4 h-4"></i> List
            </button>
            <button onclick="app.switchView('tree')" id="btn-view-tree" class="px-3 py-1.5 rounded-md text-slate-500 hover:bg-slate-50 transition-all flex items-center gap-2">
                <i data-lucide="network" class="w-4 h-4"></i> Tree
            </button>
        </div>
    </div>

    <!-- UI Layer: Info -->
    <div id="bottom-info" class="absolute bottom-4 left-4 z-40 bg-white/80 backdrop-blur px-4 py-2 rounded-full border border-slate-200 text-xs text-slate-500 shadow-sm pointer-events-none transition-opacity duration-300">
        <span id="stats-display">Loading...</span>
    </div>

    <!-- UI Layer: Developer Credit -->
    <div class="absolute bottom-4 right-4 z-40 bg-white/80 backdrop-blur px-4 py-2 rounded-full border border-slate-200 text-xs text-slate-600 shadow-sm transition-opacity duration-300 pointer-events-auto">
        <div class="flex items-center gap-2">
            <span class="font-medium">Â© <span id="current-year"></span> Made by </span>
            <span class="font-semibold text-slate-700">Arman Rahman</span>
            <div class="flex items-center gap-1.5 ml-1">
                <a href="https://www.linkedin.com/in/armanrahman/" target="_blank" rel="noopener noreferrer" class="p-1 rounded hover:bg-blue-50 text-blue-600 transition-colors" title="LinkedIn">
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                    </svg>
                </a>
                <a href="https://github.com/helloarman" target="_blank" rel="noopener noreferrer" class="p-1 rounded hover:bg-slate-100 text-slate-700 transition-colors" title="GitHub">
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                </a>
            </div>
        </div>
    </div>

    <!-- UI Layer: Connection Feedback -->
    <div id="connection-feedback" class="hidden fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-xl z-50 animate-bounce flex items-center gap-3">
        <i data-lucide="link" class="w-4 h-4 text-indigo-400"></i>
        <span id="connection-text">Drag to target table...</span>
    </div>

    <!-- UI Layer: Toast Notification -->
    <div id="toast-notification" class="hidden fixed bottom-20 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg z-[60] text-sm opacity-0 transition-opacity duration-300">
        <span id="toast-message">Copied!</span>
    </div>

    <!-- View: Canvas -->
    <div id="canvas-container" class="relative w-full h-full overflow-hidden cursor-grab active:cursor-grabbing">
        <div id="canvas-world" class="absolute origin-top-left will-change-transform">
            <!-- SVG Layer for connections -->
            <svg id="connections-layer" class="absolute top-0 left-0 overflow-visible" style="width: 10000px; height: 10000px; z-index: 0; pointer-events: none;">
                <defs>
                    <marker id="marker-one" markerWidth="10" markerHeight="10" refX="0" refY="5" orient="auto" markerUnits="strokeWidth"><path d="M0,0 L0,10 M0,5 L3,5" stroke="#94a3b8" stroke-width="1.5" fill="none" stroke-linecap="round"/></marker>
                    <marker id="marker-many" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto" markerUnits="strokeWidth"><path d="M0,5 L8,5 M8,0 L0,5 L8,10" stroke="#94a3b8" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></marker>
                    <marker id="marker-one-end" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto" markerUnits="strokeWidth"><path d="M8,0 L8,10 M0,5 L8,5" stroke="#94a3b8" stroke-width="1.5" fill="none" stroke-linecap="round"/></marker>
                    <marker id="marker-arrow" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto" markerUnits="strokeWidth"><path d="M0,0 L8,4 L0,8 L2,4 Z" fill="#6366f1" /></marker>
                </defs>
            </svg>
            <!-- Nodes Layer -->
            <div id="nodes-layer" class="absolute top-0 left-0" style="z-index: 1;"></div>
            <!-- Labels Layer -->
             <div id="labels-layer" class="absolute top-0 left-0 pointer-events-none" style="z-index: 2;"></div>
        </div>
    </div>

    <!-- View: List Container -->
    <div id="list-view-container" class="hidden absolute inset-0 bg-slate-50 z-30 overflow-y-auto pt-20 pb-10 px-4">
        <div class="max-w-4xl mx-auto space-y-8" id="list-content"></div>
    </div>

    <!-- View: Tree Container -->
    <div id="tree-view-container" class="hidden absolute inset-0 bg-slate-50 z-30 overflow-y-auto pt-20 pb-10 px-4">
        <div class="max-w-3xl mx-auto" id="tree-content"></div>
    </div>

    <!-- Modals -->
    <div id="modal-backdrop" class="hidden fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center transition-opacity opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform scale-95 transition-transform p-6" id="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Create New Table</h3>
                <button onclick="app.closeModal()" class="p-1 hover:bg-gray-100 rounded-full text-gray-500">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="flex flex-col gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Table Name</label>
                    <div class="relative">
                        <input type="text" id="new-table-name" placeholder="e.g. User Orders" 
                            class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                            onkeyup="if(event.key === 'Enter') app.addTable()">
                        <div class="absolute left-3 top-2.5 text-slate-400">
                            <i data-lucide="type" class="w-4 h-4"></i>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">Preview: <span id="name-preview" class="font-mono text-indigo-600 font-medium">...</span></p>
                </div>
                <button onclick="app.addTable()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-medium transition-colors shadow-sm">
                    Create Table
                </button>
            </div>
        </div>
    </div>

    <div id="clear-modal-backdrop" class="hidden fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center transition-opacity opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-95 transition-transform p-6" id="clear-modal-content">
            <div class="flex flex-col items-center text-center gap-4">
                <div class="w-12 h-12 rounded-full bg-rose-100 text-rose-500 flex items-center justify-center">
                    <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800">Clear Board?</h3>
                    <p class="text-sm text-slate-500 mt-1">All tables and relationships will be permanently deleted. This action cannot be undone.</p>
                </div>
                <div class="flex gap-3 w-full mt-2">
                    <button onclick="app.closeClearModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition-colors">
                        Cancel
                    </button>
                    <button onclick="app.confirmClear()" class="flex-1 px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg font-medium transition-colors shadow-sm">
                        Clear All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="delete-table-modal-backdrop" class="hidden fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center transition-opacity opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-95 transition-transform p-6" id="delete-table-modal-content">
            <div class="flex flex-col items-center text-center gap-4">
                <div class="w-12 h-12 rounded-full bg-rose-100 text-rose-500 flex items-center justify-center">
                    <i data-lucide="trash-2" class="w-6 h-6"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-800">Delete Table?</h3>
                    <p class="text-sm text-slate-500 mt-1">Table "<span id="delete-table-name" class="font-semibold text-slate-700"></span>" and all its relationships will be permanently deleted.</p>
                </div>
                <div class="flex gap-3 w-full mt-2">
                    <button onclick="app.closeDeleteTableModal()" class="flex-1 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition-colors">
                        Cancel
                    </button>
                    <button onclick="app.confirmDeleteTable()" class="flex-1 px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg font-medium transition-colors shadow-sm">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="expand-modal-backdrop" class="hidden fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm flex items-center justify-center transition-opacity opacity-0" onclick="if(event.target === this) app.closeExpandModal()">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden transform scale-95 transition-transform" id="expand-modal-content">
            <div class="flex items-center justify-between p-4 border-b border-slate-200 bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800" id="expand-modal-title">Table Details</h3>
                <button onclick="app.closeExpandModal()" class="p-2 rounded-lg hover:bg-slate-200 text-slate-500 hover:text-slate-700 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="overflow-auto max-h-[calc(90vh-80px)]" id="expand-modal-body">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Javascript Application -->
    <script>
        const CONSTANTS = {
            DATA_TYPES: [
                'foreignId', 'INT', 'BIGINT', 'TINYINT', 'SMALLINT', 'DECIMAL', 'FLOAT', 'DOUBLE',
                'VARCHAR', 'TEXT', 'LONGTEXT', 'ENUM',
                'UUID', 'BOOLEAN',
                'DATE', 'TIME', 'DATETIME', 'TIMESTAMP',
                'JSON', 'BINARY'
            ],
            COLORS: ['border-blue-500', 'border-emerald-500', 'border-purple-500', 'border-amber-500', 'border-rose-500', 'border-cyan-500']
        };

        let state = {
            tables: [],
            relations: [], 
            view: { x: 0, y: 0, scale: 1 },
            ui: {
                isDraggingCanvas: false,
                dragStart: { x: 0, y: 0 },
                draggingTable: null,
                draggingField: null,
                connectingFrom: null,
                showConnectionLine: false,
                mousePos: { x: 0, y: 0 },
                renamingTableId: null,
                activeView: 'board', // 'board' | 'list' | 'tree'
                expandedNodes: new Set(), // stores paths like "rootId/childId"
                animationFrameId: null,
                selectedRelation: null,
                sqlDialect: 'mysql', // 'mysql' | 'postgresql' | 'sqlite' | 'sqlserver'
                searchQuery: '',
                searchResults: []
            }
        };

        const generators = {
            sql: (table, dialect = null) => {
                const db = dialect || state.ui.sqlDialect || 'mysql';
                
                if (db === 'postgresql') return generators.sqlPostgreSQL(table);
                if (db === 'sqlite') return generators.sqlSQLite(table);
                if (db === 'sqlserver') return generators.sqlSQLServer(table);
                return generators.sqlMySQL(table);
            },
            sqlMySQL: (table) => {
                let sql = `CREATE TABLE ${table.name} (\n`;
                const lines = table.fields.map(f => {
                    let typeStr = f.type;
                    if (f.type === 'foreignId') typeStr = 'BIGINT UNSIGNED';
                    if (f.type === 'ENUM' && f.enumValues) typeStr = `ENUM(${f.enumValues})`;
                    let line = `  ${f.name} ${typeStr}`;
                    if (f.isPk && f.type === 'BIGINT') line += ' AUTO_INCREMENT PRIMARY KEY';
                    else if (f.isPk) line += ' PRIMARY KEY';
                    if (!f.isNullable && !f.isPk) line += ' NOT NULL';
                    return line;
                });
                state.relations.filter(r => r.toTableId === table.id).forEach(r => {
                    const fromT = state.tables.find(t => t.id === r.fromTableId);
                    const field = table.fields.find(f => f.id === r.fkFieldId);
                    if(fromT && field) { lines.push(`  FOREIGN KEY (${field.name}) REFERENCES ${fromT.name}(id) ON DELETE CASCADE`); }
                });
                sql += lines.join(',\n');
                sql += '\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;';
                return sql;
            },
            sqlPostgreSQL: (table) => {
                let sql = `CREATE TABLE ${table.name} (\n`;
                const lines = table.fields.map(f => {
                    let typeStr = f.type;
                    if (f.type === 'VARCHAR') typeStr = 'VARCHAR(255)';
                    if (f.type === 'BIGINT') typeStr = 'BIGINT';
                    if (f.type === 'foreignId') typeStr = 'BIGINT';
                    if (f.type === 'TIMESTAMP') typeStr = 'TIMESTAMP';
                    if (f.type === 'UUID') typeStr = 'UUID';
                    if (f.type === 'TEXT') typeStr = 'TEXT';
                    if (f.type === 'BOOLEAN') typeStr = 'BOOLEAN';
                    if (f.type === 'ENUM' && f.enumValues) {
                        const vals = f.enumValues.split(',').map(v => v.trim()).join(', ');
                        typeStr = `VARCHAR(50) CHECK (${f.name} IN (${vals}))`;
                    }
                    let line = `  ${f.name} ${typeStr}`;
                    if (f.isPk && f.type === 'BIGINT') line = `  ${f.name} BIGSERIAL PRIMARY KEY`;
                    else if (f.isPk) line += ' PRIMARY KEY';
                    if (!f.isNullable && !f.isPk) line += ' NOT NULL';
                    return line;
                });
                state.relations.filter(r => r.toTableId === table.id).forEach(r => {
                    const fromT = state.tables.find(t => t.id === r.fromTableId);
                    const field = table.fields.find(f => f.id === r.fkFieldId);
                    if(fromT && field) { lines.push(`  CONSTRAINT fk_${table.name}_${field.name} FOREIGN KEY (${field.name}) REFERENCES ${fromT.name}(id) ON DELETE CASCADE`); }
                });
                sql += lines.join(',\n');
                sql += '\n);';
                return sql;
            },
            sqlSQLite: (table) => {
                let sql = `CREATE TABLE ${table.name} (\n`;
                const lines = table.fields.map(f => {
                    let typeStr = f.type;
                    if (f.type === 'VARCHAR') typeStr = 'TEXT';
                    if (f.type === 'BIGINT') typeStr = 'INTEGER';
                    if (f.type === 'foreignId') typeStr = 'INTEGER';
                    if (f.type === 'TIMESTAMP') typeStr = 'TEXT';
                    if (f.type === 'UUID') typeStr = 'TEXT';
                    if (f.type === 'BOOLEAN') typeStr = 'INTEGER';
                    if (f.type === 'ENUM') typeStr = 'TEXT';
                    let line = `  ${f.name} ${typeStr}`;
                    if (f.isPk) line += ' PRIMARY KEY AUTOINCREMENT';
                    if (!f.isNullable && !f.isPk) line += ' NOT NULL';
                    return line;
                });
                state.relations.filter(r => r.toTableId === table.id).forEach(r => {
                    const fromT = state.tables.find(t => t.id === r.fromTableId);
                    const field = table.fields.find(f => f.id === r.fkFieldId);
                    if(fromT && field) { lines.push(`  FOREIGN KEY (${field.name}) REFERENCES ${fromT.name}(id) ON DELETE CASCADE`); }
                });
                sql += lines.join(',\n');
                sql += '\n);';
                return sql;
            },
            sqlSQLServer: (table) => {
                let sql = `CREATE TABLE ${table.name} (\n`;
                const lines = table.fields.map(f => {
                    let typeStr = f.type;
                    if (f.type === 'VARCHAR') typeStr = 'NVARCHAR(255)';
                    if (f.type === 'BIGINT') typeStr = 'BIGINT';
                    if (f.type === 'foreignId') typeStr = 'BIGINT';
                    if (f.type === 'TEXT') typeStr = 'NVARCHAR(MAX)';
                    if (f.type === 'BOOLEAN') typeStr = 'BIT';
                    if (f.type === 'UUID') typeStr = 'UNIQUEIDENTIFIER';
                    if (f.type === 'TIMESTAMP') typeStr = 'DATETIME2';
                    if (f.type === 'ENUM' && f.enumValues) {
                        const vals = f.enumValues.split(',').map(v => v.trim()).join(', ');
                        typeStr = `NVARCHAR(50) CHECK (${f.name} IN (${vals}))`;
                    }
                    let line = `  ${f.name} ${typeStr}`;
                    if (f.isPk && f.type === 'BIGINT') line += ' IDENTITY(1,1) PRIMARY KEY';
                    else if (f.isPk) line += ' PRIMARY KEY';
                    if (!f.isNullable && !f.isPk) line += ' NOT NULL';
                    return line;
                });
                state.relations.filter(r => r.toTableId === table.id).forEach(r => {
                    const fromT = state.tables.find(t => t.id === r.fromTableId);
                    const field = table.fields.find(f => f.id === r.fkFieldId);
                    if(fromT && field) { lines.push(`  CONSTRAINT FK_${table.name}_${field.name} FOREIGN KEY (${field.name}) REFERENCES ${fromT.name}(id) ON DELETE CASCADE`); }
                });
                sql += lines.join(',\n');
                sql += '\n);';
                return sql;
            },
            laravel: (table) => {
                let php = `Schema::create('${table.name}', function (Blueprint $table) {\n`;
                table.fields.forEach(f => {
                    let method = 'string';
                    let args = `'${f.name}'`;
                    const rel = state.relations.find(r => r.toTableId === table.id && r.fkFieldId === f.id);
                    if (rel) {
                        const fromTable = state.tables.find(t => t.id === rel.fromTableId);
                        if (fromTable) {
                            let line = `    $table->foreignId('${f.name}')`;
                            if (f.isNullable) line += '->nullable()';
                            line += `->constrained('${fromTable.name}')->onDelete('cascade')`;
                            line += ';';
                            php += line + '\n';
                            return; 
                        }
                    }
                    switch(f.type) {
                        case 'foreignId': method = 'foreignId'; break;
                        case 'UUID': method = 'uuid'; break;
                        case 'INT': method = 'integer'; break;
                        case 'BIGINT': method = 'bigInteger'; break;
                        case 'TINYINT': method = 'tinyInteger'; break;
                        case 'SMALLINT': method = 'smallInteger'; break;
                        case 'DECIMAL': method = 'decimal'; break;
                        case 'FLOAT': method = 'float'; break;
                        case 'DOUBLE': method = 'double'; break;
                        case 'TEXT': method = 'text'; break;
                        case 'LONGTEXT': method = 'longText'; break;
                        case 'BOOLEAN': method = 'boolean'; break;
                        case 'DATE': method = 'date'; break;
                        case 'TIME': method = 'time'; break;
                        case 'DATETIME': method = 'dateTime'; break;
                        case 'TIMESTAMP': method = 'timestamp'; break;
                        case 'JSON': method = 'json'; break;
                        case 'BINARY': method = 'binary'; break;
                        case 'ENUM': 
                            method = 'enum'; 
                            const arrValues = f.enumValues ? f.enumValues.split(',').map(s => `'${s.trim().replace(/^['"]|['"]$/g, '')}'`).join(', ') : '';
                            args = `'${f.name}', [${arrValues}]`;
                            break;
                    }
                    if (f.name === 'id' && f.isPk) {
                        if (f.type === 'BIGINT' || f.type === 'foreignId') method = 'id';
                        else if (f.type === 'UUID') method = 'uuid';
                        args = f.name === 'id' && method === 'id' ? '' : `'${f.name}'`;
                    }
                    if (f.name === 'created_at' && f.type === 'TIMESTAMP') { php += `    $table->timestamps();\n`; return; }
                    let line = `    $table->${method}(${args})`;
                    if (f.isPk && f.name !== 'id') line += '->primary()';
                    if (f.isNullable) line += '->nullable()';
                    line += ';';
                    php += line + '\n';
                });
                php += `});`;
                return php;
            },
            relations: (table) => {
                const singularName = app.getSingular(table.name);
                const modelName = singularName.split(/[\s_]+/).map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join('');
                
                // Find relationships where this table is the parent (hasMany/hasOne)
                const childRels = state.relations.filter(r => r.fromTableId === table.id);
                
                // Find relationships where this table is the child (belongsTo)
                const parentRels = state.relations.filter(r => r.toTableId === table.id);
                
                let php = '';
                
                // BelongsTo relationships (this table has foreign keys)
                parentRels.forEach(rel => {
                    const parentTable = state.tables.find(t => t.id === rel.fromTableId);
                    if (!parentTable) return;
                    
                    const parentSingular = app.getSingular(parentTable.name);
                    const parentModelName = parentSingular.split(/[\s_]+/).map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join('');
                    const methodName = parentSingular.split(/[\s_]+/).map((word, i) => i === 0 ? word.toLowerCase() : word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join('');
                    
                    php += `public function ${methodName}()\n{\n    return $this->belongsTo(${parentModelName}::class);\n}\n\n`;
                });
                
                // HasMany/HasOne relationships (other tables reference this table)
                childRels.forEach(rel => {
                    const childTable = state.tables.find(t => t.id === rel.toTableId);
                    if (!childTable) return;
                    
                    const childSingular = app.getSingular(childTable.name);
                    const childModelName = childSingular.split(/[\s_]+/).map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join('');
                    
                    if (rel.type === '1:1') {
                        const methodName = childSingular.split(/[\s_]+/).map((word, i) => i === 0 ? word.toLowerCase() : word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join('');
                        php += `public function ${methodName}()\n{\n    return $this->hasOne(${childModelName}::class);\n}\n\n`;
                    } else {
                        const methodName = childTable.name.split(/[\s_]+/).map((word, i) => i === 0 ? word.toLowerCase() : word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join('');
                        php += `public function ${methodName}()\n{\n    return $this->hasMany(${childModelName}::class);\n}\n\n`;
                    }
                });
                
                return php.trim() || '// No relationships defined';
            }
        };

        const app = {
            init: () => {
                document.getElementById('current-year').textContent = new Date().getFullYear();
                app.loadState();
                if (state.tables.length === 0) {
                    state.tables = [{
                        id: 'users_tbl', name: 'users', x: 100, y: 100, color: 'border-blue-500', activeTab: 'fields',
                        fields: [
                            { id: 'f1', name: 'id', type: 'UUID', isPk: true, isNullable: false },
                            { id: 'f2', name: 'email', type: 'VARCHAR', isPk: false, isNullable: false },
                            { id: 'f3', name: 'created_at', type: 'TIMESTAMP', isPk: false, isNullable: true },
                        ]
                    }];
                }
                
                // Initialize expandedNodes if it was lost in parsing (Set is not JSON stringifiable)
                if(!state.ui.expandedNodes) state.ui.expandedNodes = new Set();
                
                app.updateCanvasTransform();
                app.renderAll();
                app.attachListeners();
                lucide.createIcons();
                document.getElementById('new-table-name').addEventListener('input', (e) => {
                    document.getElementById('name-preview').textContent = app.formatName(e.target.value) || '...';
                });
            },

            saveState: () => {
                localStorage.setItem('db_workboard_state', JSON.stringify({
                    tables: state.tables,
                    relations: state.relations,
                    view: state.view
                }));
            },

            loadState: () => {
                const saved = localStorage.getItem('db_workboard_state');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        state.tables = parsed.tables || [];
                        state.relations = parsed.relations || [];
                        state.view = parsed.view || { x: 0, y: 0, scale: 1 };
                        state.ui.expandedNodes = new Set(); // Reset visual state
                    } catch (e) { console.error('Failed to load state', e); }
                }
            },

            // --- View Switching ---
            switchView: (mode) => {
                state.ui.activeView = mode;
                const boardBtn = document.getElementById('btn-view-board');
                const listBtn = document.getElementById('btn-view-list');
                const treeBtn = document.getElementById('btn-view-tree');
                
                const canvas = document.getElementById('canvas-container');
                const list = document.getElementById('list-view-container');
                const tree = document.getElementById('tree-view-container');
                
                const leftToolbar = document.getElementById('left-toolbar');
                const bottomInfo = document.getElementById('bottom-info');

                // Reset styles
                const activeClass = "px-3 py-1.5 rounded-md bg-indigo-50 text-indigo-600 shadow-sm transition-all flex items-center gap-2";
                const inactiveClass = "px-3 py-1.5 rounded-md text-slate-500 hover:bg-slate-50 transition-all flex items-center gap-2";
                
                boardBtn.className = mode === 'board' ? activeClass : inactiveClass;
                listBtn.className = mode === 'list' ? activeClass : inactiveClass;
                treeBtn.className = mode === 'tree' ? activeClass : inactiveClass;

                canvas.classList.add('hidden');
                list.classList.add('hidden');
                tree.classList.add('hidden');
                leftToolbar.classList.add('opacity-20', 'pointer-events-none');
                bottomInfo.classList.add('opacity-0');

                if (mode === 'board') {
                    canvas.classList.remove('hidden');
                    leftToolbar.classList.remove('opacity-20', 'pointer-events-none');
                    bottomInfo.classList.remove('opacity-0');
                    app.renderAll();
                } else if (mode === 'list') {
                    list.classList.remove('hidden');
                    app.renderListView();
                } else if (mode === 'tree') {
                    tree.classList.remove('hidden');
                    app.renderTreeView();
                }
            },

            // --- Search Functions ---
            handleSearch: (query) => {
                state.ui.searchQuery = query.toLowerCase().trim();
                const clearBtn = document.getElementById('clear-search-btn');
                
                if (query.trim()) {
                    clearBtn.classList.remove('hidden');
                    app.updateSearchResults();
                    app.showSearchSuggestions();
                } else {
                    clearBtn.classList.add('hidden');
                    state.ui.searchResults = [];
                    app.hideSearchSuggestions();
                    app.clearSearchHighlights();
                }
            },
            
            updateSearchResults: () => {
                const query = state.ui.searchQuery;
                if (!query) {
                    state.ui.searchResults = [];
                    return;
                }
                
                state.ui.searchResults = state.tables.filter(table => {
                    // Search in table name
                    if (table.name.toLowerCase().includes(query)) return true;
                    
                    // Search in field names
                    if (table.fields.some(f => f.name.toLowerCase().includes(query))) return true;
                    
                    // Search in field types
                    if (table.fields.some(f => f.type.toLowerCase().includes(query))) return true;
                    
                    return false;
                }).map(table => ({
                    table,
                    matchedFields: table.fields.filter(f => 
                        f.name.toLowerCase().includes(query) || 
                        f.type.toLowerCase().includes(query)
                    )
                }));
                
                app.renderSearchSuggestions();
            },
            
            renderSearchSuggestions: () => {
                const container = document.getElementById('suggestions-list');
                const results = state.ui.searchResults;
                
                if (results.length === 0) {
                    container.innerHTML = '<div class="px-4 py-3 text-sm text-slate-500 italic">No tables found</div>';
                    return;
                }
                
                container.innerHTML = results.map(({ table, matchedFields }) => {
                    const fieldMatches = matchedFields.length > 0 
                        ? `<div class="mt-1 flex flex-wrap gap-1">${matchedFields.slice(0, 3).map(f => 
                            `<span class="text-[10px] px-1.5 py-0.5 bg-indigo-50 text-indigo-600 rounded font-mono">${f.name}</span>`
                          ).join('')}${matchedFields.length > 3 ? '<span class="text-[10px] text-slate-400">+' + (matchedFields.length - 3) + ' more</span>' : ''}</div>` 
                        : '';
                    
                    return `
                        <button 
                            onclick="app.selectSearchResult('${table.id}')"
                            class="w-full px-4 py-2 text-left hover:bg-indigo-50 transition-colors group"
                        >
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="table-2" class="w-4 h-4 text-slate-400 group-hover:text-indigo-600"></i>
                                    <span class="text-sm font-medium text-slate-700 group-hover:text-indigo-600">${table.name}</span>
                                </div>
                                <span class="text-xs text-slate-400">${table.fields.length} fields</span>
                            </div>
                            ${fieldMatches}
                        </button>
                    `;
                }).join('');
                
                lucide.createIcons({ root: container });
            },
            
            showSearchSuggestions: () => {
                if (state.ui.searchResults.length > 0 || state.ui.searchQuery) {
                    document.getElementById('search-suggestions').classList.remove('hidden');
                }
            },
            
            hideSearchSuggestions: () => {
                document.getElementById('search-suggestions').classList.add('hidden');
            },
            
            selectSearchResult: (tableId) => {
                const table = state.tables.find(t => t.id === tableId);
                if (!table) return;
                
                app.hideSearchSuggestions();
                
                if (state.ui.activeView === 'board') {
                    // Center on the table
                    const centerX = window.innerWidth / 2 - table.x * state.view.scale - 150;
                    const centerY = window.innerHeight / 2 - table.y * state.view.scale - 200;
                    state.view.x = centerX;
                    state.view.y = centerY;
                    app.updateCanvasTransform();
                    
                    // Highlight the table
                    const el = document.getElementById(tableId);
                    if (el) {
                        el.classList.add('ring-4', 'ring-indigo-400');
                        setTimeout(() => el.classList.remove('ring-4', 'ring-indigo-400'), 2000);
                    }
                } else if (state.ui.activeView === 'list') {
                    // Scroll to the table in list view
                    const el = document.getElementById(`list-card-${tableId}`);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        el.classList.add('ring-4', 'ring-indigo-400');
                        setTimeout(() => el.classList.remove('ring-4', 'ring-indigo-400'), 2000);
                    }
                } else if (state.ui.activeView === 'tree') {
                    // Switch to board view and center on table
                    app.switchView('board');
                    setTimeout(() => {
                        const centerX = window.innerWidth / 2 - table.x * state.view.scale - 150;
                        const centerY = window.innerHeight / 2 - table.y * state.view.scale - 200;
                        state.view.x = centerX;
                        state.view.y = centerY;
                        app.updateCanvasTransform();
                        
                        const el = document.getElementById(tableId);
                        if (el) {
                            el.classList.add('ring-4', 'ring-indigo-400');
                            setTimeout(() => el.classList.remove('ring-4', 'ring-indigo-400'), 2000);
                        }
                    }, 100);
                }
            },
            
            clearSearch: () => {
                document.getElementById('table-search').value = '';
                state.ui.searchQuery = '';
                state.ui.searchResults = [];
                document.getElementById('clear-search-btn').classList.add('hidden');
                app.hideSearchSuggestions();
                app.clearSearchHighlights();
            },
            
            clearSearchHighlights: () => {
                document.querySelectorAll('.ring-4.ring-indigo-400').forEach(el => {
                    el.classList.remove('ring-4', 'ring-indigo-400');
                });
            },

            // --- Tree View Logic ---
            toggleTreeNode: (path) => {
                if(state.ui.expandedNodes.has(path)) {
                    state.ui.expandedNodes.delete(path);
                } else {
                    state.ui.expandedNodes.add(path);
                }
                app.renderTreeView();
            },

            renderTreeView: () => {
                const container = document.getElementById('tree-content');
                container.innerHTML = '';

                // Build Graph
                const adj = {}; 
                const inDegree = {};
                state.tables.forEach(t => { adj[t.id] = []; inDegree[t.id] = 0; });
                
                state.relations.forEach(r => {
                    if (adj[r.fromTableId]) {
                        adj[r.fromTableId].push(r.toTableId);
                        inDegree[r.toTableId] = (inDegree[r.toTableId] || 0) + 1;
                    }
                });

                // Get Roots
                const roots = state.tables.filter(t => inDegree[t.id] === 0);
                
                // Fallback for circular/complex graphs: ensure every table appears at least once if not reached
                // For now simple root logic. If no roots found (fully circular), pick one?
                let nodesToRender = [...roots];
                if(nodesToRender.length === 0 && state.tables.length > 0) nodesToRender = [state.tables[0]];

                const renderNode = (tableId, parentPath = 'root', depth = 0, visited = new Set()) => {
                    if (visited.has(tableId)) return ''; 
                    // Allow revisiting in tree (A->B, C->B) but check recursion depth or cycles if needed
                    // Simple tree visualization usually allows duplication across branches
                    const currentPath = `${parentPath}/${tableId}`;
                    
                    const table = state.tables.find(t => t.id === tableId);
                    if (!table) return '';

                    const children = adj[tableId] || [];
                    const hasChildren = children.length > 0;
                    const isExpanded = state.ui.expandedNodes.has(currentPath);
                    const baseColor = table.color.split('-')[1];

                    // Styling based on level
                    const paddingLeft = depth > 0 ? 'ml-6 border-l-2 border-slate-200 pl-3' : '';

                    let html = `
                        <div class="mb-2 ${paddingLeft} transition-all">
                            <div class="flex items-center gap-2 group">
                                <button onclick="app.toggleTreeNode('${currentPath}')" 
                                    class="w-6 h-6 flex items-center justify-center rounded hover:bg-slate-200 text-slate-400 transition-colors ${!hasChildren ? 'invisible' : ''}">
                                    <i data-lucide="chevron-right" class="w-4 h-4 transition-transform duration-200 ${isExpanded ? 'rotate-90' : ''}"></i>
                                </button>
                                
                                <div class="flex-1 bg-white rounded-lg border border-slate-200 shadow-sm p-3 hover:shadow-md transition-all flex items-center gap-3 relative overflow-hidden" 
                                     onclick="app.toggleTreeNode('${currentPath}')">
                                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-${baseColor}-500"></div>
                                    <div class="p-1.5 rounded-md bg-${baseColor}-50 text-${baseColor}-600">
                                        <i data-lucide="table-2" class="w-4 h-4"></i>
                                    </div>
                                    <div class="flex flex-col">
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-slate-700 text-sm">${table.name}</span>
                                            <span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 rounded-full border border-slate-100">${table.fields.length}</span>
                                        </div>
                                        <div class="text-[10px] text-slate-400 font-mono flex gap-2">
                                            ${table.fields.slice(0, 3).map(f => f.name).join(', ')}${table.fields.length > 3 ? '...' : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${hasChildren && isExpanded ? `
                                <div class="mt-2">
                                    ${children.map(childId => renderNode(childId, currentPath, depth + 1, new Set(visited).add(tableId))).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                    return html;
                };

                if (nodesToRender.length === 0) {
                    container.innerHTML = `<div class="text-center text-slate-400 py-20">No tables found. Switch to Board view to add tables.</div>`;
                } else {
                    nodesToRender.forEach(t => {
                        const div = document.createElement('div');
                        div.innerHTML = renderNode(t.id);
                        container.appendChild(div);
                    });
                }
                
                lucide.createIcons();
            },

            renderListView: () => {
                const container = document.getElementById('list-content');
                container.innerHTML = '';

                const tableLevelMap = {};
                state.tables.forEach(t => tableLevelMap[t.id] = 0);

                let changed = true;
                let iterations = 0;
                while(changed && iterations < state.tables.length + 2) {
                    changed = false;
                    state.relations.forEach(r => {
                        if (tableLevelMap[r.toTableId] < tableLevelMap[r.fromTableId] + 1) {
                            tableLevelMap[r.toTableId] = tableLevelMap[r.fromTableId] + 1;
                            changed = true;
                        }
                    });
                    iterations++;
                }

                const maxLevel = Object.values(tableLevelMap).length ? Math.max(...Object.values(tableLevelMap)) : 0;
                
                for (let l = 0; l <= maxLevel; l++) {
                    const tablesInLevel = state.tables.filter(t => tableLevelMap[t.id] === l);
                    if (tablesInLevel.length === 0) continue;

                    const levelSection = document.createElement('div');
                    levelSection.className = "space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-500";
                    const levelTitle = l === 0 ? "Level 0 (Root Tables)" : `Level ${l} (Dependent Tables)`;
                    levelSection.innerHTML = `<h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-2 border-b border-slate-200 pb-2 flex justify-between"><span>${levelTitle}</span> <span class="text-slate-300 font-normal">${tablesInLevel.length} tables</span></h2>`;

                    const grid = document.createElement('div');
                    grid.className = "grid grid-cols-1 gap-4";

                    tablesInLevel.forEach(table => {
                        const cardWrapper = document.createElement('div');
                        cardWrapper.id = `list-card-${table.id}`;
                        cardWrapper.className = "bg-white rounded-lg border border-slate-200 shadow-sm flex flex-col hover:shadow-md transition-shadow relative overflow-hidden";
                        grid.appendChild(cardWrapper);
                        
                        // Pass element explicitly to avoid query selector issues during rendering loop
                        app.renderListCard(table, cardWrapper);
                    });

                    levelSection.appendChild(grid);
                    container.appendChild(levelSection);
                }
                
                lucide.createIcons();
            },

            renderListCard: (table, targetEl = null) => {
                const el = targetEl || document.getElementById(`list-card-${table.id}`);
                if(!el) return;

                const baseColor = table.color.split('-')[1];
                const parentRels = state.relations.filter(r => r.toTableId === table.id);
                const parentNames = parentRels.map(r => {
                    const p = state.tables.find(t => t.id === r.fromTableId);
                    return p ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium bg-indigo-50 text-indigo-700 border border-indigo-100">${p.name}</span>` : '';
                }).join(' ');

                const accent = `<div class="absolute left-0 top-0 bottom-0 w-1 bg-${baseColor}-500"></div>`;

                const headerHtml = `
                    <div class="p-4 pb-2">
                        <div class="flex items-start justify-between">
                            <div>
                                <div class="flex items-center gap-2">
                                    <h3 class="font-bold text-slate-800 text-lg">${table.name}</h3>
                                    <div class="text-[10px] text-slate-400 font-mono bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">${table.fields.length} cols</div>
                                </div>
                                <div class="text-xs text-slate-500 mt-1.5 flex flex-wrap gap-2 items-center">
                                    ${parentRels.length > 0 
                                        ? `<span class="font-semibold text-slate-400 flex items-center gap-1"><i data-lucide="arrow-up-left" class="w-3 h-3"></i> Prerequisites:</span> ${parentNames}` 
                                        : '<span class="text-slate-400 italic flex items-center gap-1"><i data-lucide="minus-circle" class="w-3 h-3"></i> No dependencies</span>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const tabsHtml = `
                    <div class="flex text-[11px] font-semibold border-b border-slate-100 bg-slate-50/50 px-4">
                        <button onclick="app.setTab('${table.id}', 'fields')" 
                            class="py-2 px-3 text-center transition-colors relative ${table.activeTab === 'fields' ? `text-${baseColor}-600 bg-white border-x border-t border-slate-100 rounded-t-lg -mb-px` : 'text-slate-400 hover:text-slate-600'}">
                            Structure
                        </button>
                        <button onclick="app.setTab('${table.id}', 'sql')" 
                            class="py-2 px-3 text-center transition-colors relative ${table.activeTab === 'sql' ? `text-${baseColor}-600 bg-white border-x border-t border-slate-100 rounded-t-lg -mb-px` : 'text-slate-400 hover:text-slate-600'}">
                            SQL
                        </button>
                        <button onclick="app.setTab('${table.id}', 'laravel')" 
                            class="py-2 px-3 text-center transition-colors relative ${table.activeTab === 'laravel' ? `text-${baseColor}-600 bg-white border-x border-t border-slate-100 rounded-t-lg -mb-px` : 'text-slate-400 hover:text-slate-600'}">
                            Laravel
                        </button>
                    </div>
                `;

                let contentHtml = '';

                if (table.activeTab === 'fields') {
                    contentHtml = `
                        <div class="p-4 pt-3">
                            <div class="flex flex-wrap gap-2">
                                ${table.fields.map(f => {
                                    let icon = '';
                                    if(f.isPk) icon = '<i data-lucide="key" class="w-3 h-3 text-amber-500 mr-1"></i>';
                                    else if(f.isFk) icon = '<i data-lucide="link-2" class="w-3 h-3 text-blue-500 mr-1"></i>';
                                    
                                    return `
                                        <div class="flex items-center text-xs text-slate-600 bg-slate-50 rounded px-2 py-1 border border-slate-100" title="${f.type}">
                                            ${icon}
                                            <span class="font-mono font-medium">${f.name}</span>
                                            <span class="text-[9px] uppercase text-slate-400 font-bold ml-1.5 opacity-70 mr-1.5">${f.type.substring(0,3)}</span>
                                            
                                            <button onclick="app.toggleFieldProp('${table.id}', '${f.id}', 'isNullable')" 
                                                class="px-1.5 py-0.5 rounded text-[9px] font-bold border transition-colors ${f.isNullable ? 'bg-indigo-100 text-indigo-600 border-indigo-200' : 'bg-white text-slate-300 border-slate-200 hover:border-slate-300 hover:text-slate-400'}" 
                                                title="Toggle Nullable" 
                                                ${f.isPk ? 'disabled style="opacity:0.3"' : ''}>
                                                N
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                } else if (table.activeTab === 'sql') {
                    const dialectName = {'mysql': 'MySQL', 'postgresql': 'PostgreSQL', 'sqlite': 'SQLite', 'sqlserver': 'SQL Server'}[state.ui.sqlDialect];
                    contentHtml = `
                        <div class="p-0 bg-slate-50/50">
                            <div class="px-4 py-2 border-b border-slate-100 bg-white flex items-center justify-between">
                                <span class="text-xs text-slate-500 font-semibold">Database:</span>
                                <div class="relative">
                                    <select onchange="app.changeSqlDialect(this.value)" class="appearance-none bg-slate-100 hover:bg-slate-200 text-xs text-slate-700 font-semibold py-1.5 px-3 pr-8 rounded-md outline-none cursor-pointer transition-colors border border-slate-200">
                                        <option value="mysql" ${state.ui.sqlDialect === 'mysql' ? 'selected' : ''}>MySQL</option>
                                        <option value="postgresql" ${state.ui.sqlDialect === 'postgresql' ? 'selected' : ''}>PostgreSQL</option>
                                        <option value="sqlite" ${state.ui.sqlDialect === 'sqlite' ? 'selected' : ''}>SQLite</option>
                                        <option value="sqlserver" ${state.ui.sqlDialect === 'sqlserver' ? 'selected' : ''}>SQL Server</option>
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute right-2 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500 pointer-events-none"></i>
                                </div>
                            </div>
                            <div class="overflow-auto max-h-48 p-4 custom-scrollbar">
                                <pre class="code-block text-slate-600 text-xs">${generators.sql(table)}</pre>
                            </div>
                            <div class="px-4 py-2 border-t border-slate-100 bg-white flex justify-end">
                                <button onclick="app.copyToClipboard(generators.sql(state.tables.find(t=>t.id=='${table.id}')))" class="flex items-center justify-center gap-2 text-xs font-semibold bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded transition-colors">
                                    <i data-lucide="copy" class="w-3 h-3"></i> Copy SQL
                                </button>
                            </div>
                        </div>
                    `;
                } else if (table.activeTab === 'laravel') {
                    const tableName = app.formatName(table.name);
                    const migrationCmd = `php artisan make:migration create_${tableName}_table`;
                    const singularName = app.getSingular(table.name);
                    const modelName = singularName.split(/[\s_]+/).map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join('');
                    const modelCmd = `php artisan make:model ${modelName} -m`;
                    const relationsMethods = generators.relations(table);
                    contentHtml = `
                        <div class="p-0 bg-slate-50/50">
                            <div class="space-y-3">
                                <div class="border-b border-slate-200 bg-white">
                                    <div class="px-4 py-2 bg-slate-100/50">
                                        <div class="text-[10px] text-slate-500 font-bold uppercase tracking-wide">Migration</div>
                                    </div>
                                    <div class="overflow-auto max-h-40 p-4 custom-scrollbar">
                                        <pre class="code-block text-indigo-600 text-xs">${generators.laravel(table)}</pre>
                                    </div>
                                </div>
                                <div class="border-b border-slate-200 bg-white">
                                    <div class="px-4 py-2 bg-slate-100/50">
                                        <div class="text-[10px] text-slate-500 font-bold uppercase tracking-wide">Model Relationships</div>
                                    </div>
                                    <div class="overflow-auto max-h-40 p-4 custom-scrollbar">
                                        <pre class="code-block text-emerald-600 text-xs">${relationsMethods}</pre>
                                    </div>
                                </div>
                            </div>
                            <div class="px-4 py-3 space-y-2 border-t border-slate-100 bg-white">
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 bg-slate-50 border border-slate-200 rounded px-2 py-1.5">
                                        <div class="text-[9px] text-slate-400 font-semibold uppercase tracking-wide mb-0.5">Migration Command</div>
                                        <code class="text-[11px] text-slate-700 font-mono block select-all">${migrationCmd}</code>
                                    </div>
                                    <button onclick="app.copyToClipboard('${migrationCmd}')" class="flex items-center justify-center gap-1.5 text-xs font-semibold bg-slate-100 hover:bg-slate-200 text-slate-600 px-2.5 py-1.5 rounded transition-colors shrink-0">
                                        <i data-lucide="copy" class="w-3 h-3"></i>
                                    </button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="flex-1 bg-slate-50 border border-slate-200 rounded px-2 py-1.5">
                                        <div class="text-[9px] text-slate-400 font-semibold uppercase tracking-wide mb-0.5">Model Command</div>
                                        <code class="text-[11px] text-slate-700 font-mono block select-all">${modelCmd}</code>
                                    </div>
                                    <button onclick="app.copyToClipboard('${modelCmd}')" class="flex items-center justify-center gap-1.5 text-xs font-semibold bg-slate-100 hover:bg-slate-200 text-slate-600 px-2.5 py-1.5 rounded transition-colors shrink-0">
                                        <i data-lucide="copy" class="w-3 h-3"></i>
                                    </button>
                                </div>
                                <div class="pt-1 border-t border-slate-100 flex gap-2">
                                    <button onclick="app.copyToClipboard(generators.laravel(state.tables.find(t=>t.id=='${table.id}')))" class="flex-1 flex items-center justify-center gap-2 text-xs font-semibold bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded transition-colors">
                                        <i data-lucide="copy" class="w-3 h-3"></i> Copy Migration
                                    </button>
                                    <button onclick="app.copyToClipboard(generators.relations(state.tables.find(t=>t.id=='${table.id}')))" class="flex-1 flex items-center justify-center gap-2 text-xs font-semibold bg-emerald-100 hover:bg-emerald-200 text-emerald-700 px-3 py-1.5 rounded transition-colors">
                                        <i data-lucide="copy" class="w-3 h-3"></i> Copy Relations
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                el.innerHTML = accent + headerHtml + tabsHtml + contentHtml;
                lucide.createIcons({ root: el });
            },

            toggleFieldProp: (tableId, fieldId, prop) => {
                const table = state.tables.find(t => t.id === tableId);
                const field = table.fields.find(f => f.id === fieldId);
                if (field) {
                    // Rule: Primary Keys cannot be nullable
                    if (prop === 'isNullable' && field.isPk) return;

                    field[prop] = !field[prop];
                    app.saveState();
                    
                    if (state.ui.activeView === 'board') {
                        app.renderTable(table);
                    } else if (state.ui.activeView === 'list') {
                        app.renderListCard(table);
                    }
                }
            },

            // --- Helpers, State, Toast, Logic (Keep existing) ---
            generateId: () => Math.random().toString(36).substr(2, 9),
            formatName: (name) => name.trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, ''),
            getSingular: (name) => {
                if (name.endsWith('ies')) return name.slice(0, -3) + 'y';
                if (name.endsWith('s')) return name.slice(0, -1);
                return name;
            },
            showToast: (message) => {
                const toast = document.getElementById('toast-notification');
                const msgSpan = document.getElementById('toast-message');
                msgSpan.textContent = message;
                toast.classList.remove('hidden');
                setTimeout(() => { toast.classList.remove('opacity-0'); }, 10);
                setTimeout(() => {
                    toast.classList.add('opacity-0');
                    setTimeout(() => { toast.classList.add('hidden'); }, 300);
                }, 2000);
            },
            copyToClipboard: (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus(); textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    const msg = successful ? 'Copied to clipboard!' : 'Failed to copy';
                    app.showToast(msg);
                } catch (err) { app.showToast('Failed to copy'); }
                document.body.removeChild(textArea);
            },
            exportSchema: () => {
                const data = { tables: state.tables, relations: state.relations, view: state.view };
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `db-schema-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                app.showToast('Schema exported!');
            },
            exportPDF: () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Title
                doc.setFontSize(20);
                doc.setTextColor(79, 70, 229); // Indigo
                doc.text('Database Schema', 14, 20);
                
                doc.setFontSize(10);
                doc.setTextColor(100, 116, 139); // Slate
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 28);
                doc.text(`Total Tables: ${state.tables.length} | Total Relations: ${state.relations.length}`, 14, 34);
                
                let yPos = 45;
                
                // Organize tables by level
                const tableLevelMap = {};
                state.tables.forEach(t => tableLevelMap[t.id] = 0);
                let changed = true;
                let iterations = 0;
                while(changed && iterations < state.tables.length + 2) {
                    changed = false;
                    state.relations.forEach(r => {
                        if (tableLevelMap[r.toTableId] < tableLevelMap[r.fromTableId] + 1) {
                            tableLevelMap[r.toTableId] = tableLevelMap[r.fromTableId] + 1;
                            changed = true;
                        }
                    });
                    iterations++;
                }
                const maxLevel = Object.values(tableLevelMap).length ? Math.max(...Object.values(tableLevelMap)) : 0;
                
                for (let level = 0; level <= maxLevel; level++) {
                    const tablesInLevel = state.tables.filter(t => tableLevelMap[t.id] === level);
                    if (tablesInLevel.length === 0) continue;
                    
                    // Add new page if needed
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Level Header
                    doc.setFontSize(12);
                    doc.setTextColor(71, 85, 105);
                    const levelTitle = level === 0 ? 'Level 0 (Root Tables)' : `Level ${level} (Dependent Tables)`;
                    doc.text(levelTitle, 14, yPos);
                    yPos += 8;
                    
                    tablesInLevel.forEach(table => {
                        // Check if we need a new page
                        if (yPos > 240) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        // Table Name
                        doc.setFontSize(11);
                        doc.setTextColor(30, 41, 59);
                        doc.setFont(undefined, 'bold');
                        doc.text(table.name.toUpperCase(), 14, yPos);
                        yPos += 2;
                        
                        // Parent Relations
                        const parentRels = state.relations.filter(r => r.toTableId === table.id);
                        if (parentRels.length > 0) {
                            doc.setFontSize(8);
                            doc.setTextColor(100, 116, 139);
                            doc.setFont(undefined, 'normal');
                            const parentNames = parentRels.map(r => {
                                const p = state.tables.find(t => t.id === r.fromTableId);
                                return p ? p.name : '';
                            }).filter(n => n).join(', ');
                            doc.text(`References: ${parentNames}`, 14, yPos + 4);
                            yPos += 6;
                        } else {
                            yPos += 3;
                        }
                        
                        // Fields Table
                        const fieldData = table.fields.map(f => [
                            f.name,
                            f.type + (f.enumValues ? ` (${f.enumValues})` : ''),
                            f.isPk ? 'â' : '',
                            f.isNullable ? 'â' : ''
                        ]);
                        
                        doc.autoTable({
                            startY: yPos,
                            head: [['Field Name', 'Type', 'PK', 'Nullable']],
                            body: fieldData,
                            theme: 'grid',
                            styles: { fontSize: 8, cellPadding: 2 },
                            headStyles: { fillColor: [79, 70, 229], textColor: 255, fontStyle: 'bold' },
                            alternateRowStyles: { fillColor: [248, 250, 252] },
                            margin: { left: 14, right: 14 },
                            tableWidth: 'auto',
                            columnStyles: {
                                0: { cellWidth: 50 },
                                1: { cellWidth: 70 },
                                2: { cellWidth: 15, halign: 'center' },
                                3: { cellWidth: 20, halign: 'center' }
                            }
                        });
                        
                        yPos = doc.lastAutoTable.finalY + 10;
                    });
                    
                    yPos += 5;
                }
                
                // Save PDF
                doc.save(`database-schema-${new Date().toISOString().slice(0,10)}.pdf`);
                app.showToast('PDF exported successfully!');
            },
            triggerImport: () => { document.getElementById('import-file').click(); },
            handleFileSelect: (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.tables && data.relations) {
                            state.tables = data.tables; state.relations = data.relations; state.view = data.view || { x: 0, y: 0, scale: 1 };
                            app.saveState(); app.renderAll(); app.updateCanvasTransform(); app.showToast('Schema imported!');
                        } else { alert('Invalid file'); }
                    } catch (err) { alert('Error parsing JSON'); }
                    event.target.value = '';
                };
                reader.readAsText(file);
            },
            requestClear: () => {
                const backdrop = document.getElementById('clear-modal-backdrop'); const content = document.getElementById('clear-modal-content');
                backdrop.classList.remove('hidden'); setTimeout(() => { backdrop.classList.remove('opacity-0'); content.classList.remove('scale-95'); content.classList.add('scale-100'); }, 10);
            },
            closeClearModal: () => {
                const backdrop = document.getElementById('clear-modal-backdrop'); const content = document.getElementById('clear-modal-content');
                backdrop.classList.add('opacity-0'); content.classList.remove('scale-100'); content.classList.add('scale-95'); setTimeout(() => { backdrop.classList.add('hidden'); }, 200);
            },
            openExpandModal: (tableId) => {
                const table = state.tables.find(t => t.id === tableId);
                if (!table) return;
                
                const backdrop = document.getElementById('expand-modal-backdrop');
                const content = document.getElementById('expand-modal-content');
                const title = document.getElementById('expand-modal-title');
                const body = document.getElementById('expand-modal-body');
                
                title.textContent = table.name;
                body.setAttribute('data-table-id', tableId);
                
                const baseColor = table.color.split('-')[1];
                const tableName = app.formatName(table.name);
                const migrationCmd = `php artisan make:migration create_${tableName}_table`;
                const singularName = app.getSingular(table.name);
                const modelName = singularName.split(/[\s_]+/).map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join('');
                const modelCmd = `php artisan make:model ${modelName} -m`;
                const relationsMethods = generators.relations(table);
                
                const parentRels = state.relations.filter(r => r.toTableId === table.id);
                const childRels = state.relations.filter(r => r.fromTableId === table.id);
                
                body.innerHTML = `
                    <div class="p-6 space-y-6">
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-sm font-bold text-slate-700 uppercase tracking-wide mb-3 flex items-center gap-2">
                                    <i data-lucide="list" class="w-4 h-4"></i> Fields
                                </h4>
                                <div class="space-y-2">
                                    ${table.fields.map(f => {
                                        let icon = '';
                                        if(f.isPk) icon = '<i data-lucide="key" class="w-3.5 h-3.5 text-amber-500 mr-2"></i>';
                                        else if(f.isFk) icon = '<i data-lucide="link-2" class="w-3.5 h-3.5 text-blue-500 mr-2"></i>';
                                        else icon = '<div class="w-3.5 h-3.5 mr-2"></div>';
                                        
                                        return `
                                            <div class="flex items-center gap-2 p-2 bg-slate-50 rounded border border-slate-200">
                                                ${icon}
                                                <span class="font-mono text-sm font-medium text-slate-700 flex-1">${f.name}</span>
                                                <span class="text-xs px-2 py-0.5 rounded bg-slate-200 text-slate-600 font-bold">${f.type}</span>
                                                ${f.isNullable ? '<span class="text-xs px-1.5 py-0.5 rounded bg-indigo-100 text-indigo-600 font-bold">NULL</span>' : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-sm font-bold text-slate-700 uppercase tracking-wide mb-3 flex items-center gap-2">
                                    <i data-lucide="git-branch" class="w-4 h-4"></i> Relationships
                                </h4>
                                <div class="space-y-3">
                                    ${parentRels.length > 0 ? `
                                        <div>
                                            <div class="text-xs text-slate-500 font-semibold mb-1.5">Belongs To:</div>
                                            ${parentRels.map(r => {
                                                const parent = state.tables.find(t => t.id === r.fromTableId);
                                                return parent ? `<div class="text-sm px-3 py-1.5 bg-blue-50 border border-blue-200 rounded text-blue-700 font-medium">${parent.name}</div>` : '';
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    ${childRels.length > 0 ? `
                                        <div>
                                            <div class="text-xs text-slate-500 font-semibold mb-1.5">Has ${childRels.some(r => r.type === '1:1') ? 'One' : 'Many'}:</div>
                                            ${childRels.map(r => {
                                                const child = state.tables.find(t => t.id === r.toTableId);
                                                return child ? `<div class="text-sm px-3 py-1.5 bg-emerald-50 border border-emerald-200 rounded text-emerald-700 font-medium">${child.name}</div>` : '';
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    ${parentRels.length === 0 && childRels.length === 0 ? '<div class="text-sm text-slate-400 italic">No relationships</div>' : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t border-slate-200 pt-6">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-sm font-bold text-slate-700 uppercase tracking-wide flex items-center gap-2">
                                    <i data-lucide="code-2" class="w-4 h-4"></i> SQL Migration
                                </h4>
                                <div class="relative">
                                    <select onchange="app.changeSqlDialect(this.value)" class="appearance-none bg-slate-100 hover:bg-slate-200 text-xs text-slate-700 font-semibold py-1.5 px-3 pr-8 rounded-md outline-none cursor-pointer transition-colors border border-slate-200">
                                        <option value="mysql" ${state.ui.sqlDialect === 'mysql' ? 'selected' : ''}>MySQL</option>
                                        <option value="postgresql" ${state.ui.sqlDialect === 'postgresql' ? 'selected' : ''}>PostgreSQL</option>
                                        <option value="sqlite" ${state.ui.sqlDialect === 'sqlite' ? 'selected' : ''}>SQLite</option>
                                        <option value="sqlserver" ${state.ui.sqlDialect === 'sqlserver' ? 'selected' : ''}>SQL Server</option>
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute right-2 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-slate-500 pointer-events-none"></i>
                                </div>
                            </div>
                            <div class="bg-slate-900 rounded-lg p-4 overflow-x-auto">
                                <pre class="text-xs text-slate-200 font-mono">${generators.sql(table)}</pre>
                            </div>
                            <div class="mt-3 flex justify-end">
                                <button onclick="app.copyToClipboard(generators.sql(state.tables.find(t=>t.id=='${table.id}')))" class="flex items-center gap-2 text-xs font-semibold bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded transition-colors">
                                    <i data-lucide="copy" class="w-3.5 h-3.5"></i> Copy SQL
                                </button>
                            </div>
                        </div>
                        
                        <div class="border-t border-slate-200 pt-6">
                            <h4 class="text-sm font-bold text-slate-700 uppercase tracking-wide mb-3 flex items-center gap-2">
                                <i data-lucide="terminal" class="w-4 h-4"></i> Laravel
                            </h4>
                            
                            <div class="space-y-4">
                                <div>
                                    <div class="text-xs text-slate-500 font-semibold mb-2">Commands</div>
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-2">
                                            <div class="flex-1 bg-slate-50 border border-slate-200 rounded px-3 py-2">
                                                <code class="text-xs text-slate-700 font-mono block">${migrationCmd}</code>
                                            </div>
                                            <button onclick="app.copyToClipboard('${migrationCmd}')" class="p-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded transition-colors">
                                                <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                                            </button>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <div class="flex-1 bg-slate-50 border border-slate-200 rounded px-3 py-2">
                                                <code class="text-xs text-slate-700 font-mono block">${modelCmd}</code>
                                            </div>
                                            <button onclick="app.copyToClipboard('${modelCmd}')" class="p-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded transition-colors">
                                                <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="text-xs text-slate-500 font-semibold mb-2">Migration Code</div>
                                    <div class="bg-indigo-950 rounded-lg p-4 overflow-x-auto">
                                        <pre class="text-xs text-indigo-200 font-mono">${generators.laravel(table)}</pre>
                                    </div>
                                    <div class="mt-2 flex justify-end">
                                        <button onclick="app.copyToClipboard(generators.laravel(state.tables.find(t=>t.id=='${table.id}')))" class="flex items-center gap-2 text-xs font-semibold bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-2 rounded transition-colors">
                                            <i data-lucide="copy" class="w-3.5 h-3.5"></i> Copy Migration
                                        </button>
                                    </div>
                                </div>
                                
                                ${relationsMethods !== '// No relationships defined' ? `
                                <div>
                                    <div class="text-xs text-slate-500 font-semibold mb-2">Model Relationships</div>
                                    <div class="bg-emerald-950 rounded-lg p-4 overflow-x-auto">
                                        <pre class="text-xs text-emerald-200 font-mono">${relationsMethods}</pre>
                                    </div>
                                    <div class="mt-2 flex justify-end">
                                        <button onclick="app.copyToClipboard(generators.relations(state.tables.find(t=>t.id=='${table.id}')))" class="flex items-center gap-2 text-xs font-semibold bg-emerald-100 hover:bg-emerald-200 text-emerald-700 px-3 py-2 rounded transition-colors">
                                            <i data-lucide="copy" class="w-3.5 h-3.5"></i> Copy Relations
                                        </button>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                backdrop.classList.remove('hidden');
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                    lucide.createIcons({ root: body });
                }, 10);
            },
            closeExpandModal: () => {
                const backdrop = document.getElementById('expand-modal-backdrop');
                const content = document.getElementById('expand-modal-content');
                backdrop.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => {
                    backdrop.classList.add('hidden');
                }, 200);
            },
            confirmClear: () => { state.tables = []; state.relations = []; app.saveState(); app.renderAll(); app.closeClearModal(); app.showToast('Board cleared'); },
            addTable: () => {
                const input = document.getElementById('new-table-name'); const rawName = input.value; if (!rawName.trim()) return;
                const name = app.formatName(rawName);
                if (state.tables.find(t => t.name === name)) { alert('Table name exists'); return; }
                const newTable = { id: app.generateId(), name, x: -state.view.x + 200, y: -state.view.y + 200, color: CONSTANTS.COLORS[state.tables.length % CONSTANTS.COLORS.length], activeTab: 'fields', fields: [ { id: app.generateId(), name: 'id', type: 'BIGINT', isPk: true, isNullable: false } ] };
                state.tables.push(newTable); app.saveState(); input.value = ''; app.closeModal(); app.renderAll();
            },
            deleteTable: (id) => { 
                const table = state.tables.find(t => t.id === id);
                if (!table) return;
                state.ui.deletingTableId = id;
                document.getElementById('delete-table-name').textContent = table.name;
                const backdrop = document.getElementById('delete-table-modal-backdrop');
                const content = document.getElementById('delete-table-modal-content');
                backdrop.classList.remove('hidden');
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                    lucide.createIcons({ root: content });
                }, 10);
            },
            closeDeleteTableModal: () => {
                const backdrop = document.getElementById('delete-table-modal-backdrop');
                const content = document.getElementById('delete-table-modal-content');
                backdrop.classList.add('opacity-0');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
                setTimeout(() => {
                    backdrop.classList.add('hidden');
                    state.ui.deletingTableId = null;
                }, 200);
            },
            confirmDeleteTable: () => {
                const id = state.ui.deletingTableId;
                if (!id) return;
                state.tables = state.tables.filter(t => t.id !== id);
                state.relations = state.relations.filter(r => r.fromTableId !== id && r.toTableId !== id);
                app.saveState();
                app.renderAll();
                app.closeDeleteTableModal();
                app.showToast('Table deleted');
            },
            enableRename: (tableId) => { state.ui.renamingTableId = tableId; app.renderTable(state.tables.find(t => t.id === tableId)); },
            finishRename: (tableId, newName) => {
                if(!newName.trim()) { state.ui.renamingTableId = null; app.renderTable(state.tables.find(t => t.id === tableId)); return; }
                const table = state.tables.find(t => t.id === tableId);
                if(table) { table.name = app.formatName(newName); app.saveState(); }
                state.ui.renamingTableId = null; app.renderTable(table);
            },
            addField: (tableId) => {
                const table = state.tables.find(t => t.id === tableId);
                if (table) { table.fields.push({ id: app.generateId(), name: 'new_field', type: 'VARCHAR', isPk: false, isNullable: true, enumValues: '' }); app.saveState(); app.renderTable(table); app.updateStats(); }
            },
            removeField: (tableId, fieldId) => {
                const table = state.tables.find(t => t.id === tableId);
                if (table) {
                    const initialRelCount = state.relations.length; state.relations = state.relations.filter(r => r.fkFieldId !== fieldId);
                    if (state.relations.length !== initialRelCount) { app.drawConnections(); app.updateStats(); }
                    table.fields = table.fields.filter(f => f.id !== fieldId); app.saveState(); app.renderTable(table);
                }
            },
            updateField: (tableId, fieldId, key, value) => {
                const table = state.tables.find(t => t.id === tableId); const field = table.fields.find(f => f.id === fieldId);
                if (field) {
                    field[key] = key === 'name' ? app.formatName(value) : value;
                    if (key === 'name' || key === 'type') {
                        if (field.type === 'foreignId' || field.name.endsWith('_id')) {
                            const possibleTableName = field.name.endsWith('_id') ? field.name.slice(0, -3) + 's' : null;
                            const targetTable = state.tables.find(t => t.name === possibleTableName || t.name === field.name.slice(0, -3));
                            if (targetTable && targetTable.id !== table.id) {
                                const exists = state.relations.find(r => r.fromTableId === targetTable.id && r.toTableId === table.id && r.fkFieldId === field.id);
                                if (!exists) {
                                    state.relations.push({ id: app.generateId(), fromTableId: targetTable.id, toTableId: table.id, type: '1:n', fkFieldId: field.id });
                                    field.isFk = true; app.drawConnections(); app.updateStats();
                                }
                            }
                        }
                    }
                    if (key === 'type') app.renderTable(table); app.saveState();
                }
            },
            addEnumVal: (tableId, fieldId, value) => {
                if (!value.trim()) return; const table = state.tables.find(t => t.id === tableId); const field = table.fields.find(f => f.id === fieldId);
                if (field) {
                    let raw = field.enumValues ? field.enumValues.split(',') : []; let clean = raw.map(v => v.trim().replace(/^['"]|['"]$/g, '')).filter(v => v);
                    if (!clean.includes(value.trim())) clean.push(value.trim()); field.enumValues = clean.map(v => `'${v}'`).join(',');
                    app.saveState(); app.renderTable(table);
                    setTimeout(() => { const el = document.getElementById(tableId); if(el) { const input = el.querySelector(`input[data-enum-input="${fieldId}"]`); if(input) input.focus(); } }, 0);
                }
            },
            removeEnumVal: (tableId, fieldId, valueToRemove) => {
                const table = state.tables.find(t => t.id === tableId); const field = table.fields.find(f => f.id === fieldId);
                if (field) {
                    let raw = field.enumValues ? field.enumValues.split(',') : []; let clean = raw.map(v => v.trim().replace(/^['"]|['"]$/g, '')).filter(v => v);
                    clean = clean.filter(v => v !== valueToRemove); field.enumValues = clean.map(v => `'${v}'`).join(',');
                    app.saveState(); app.renderTable(table);
                }
            },
            setTab: (tableId, tabName) => { 
                const table = state.tables.find(t => t.id === tableId); 
                if(table) { 
                    table.activeTab = tabName; 
                    app.saveState(); 
                    if(state.ui.activeView === 'board') {
                        app.renderTable(table); 
                    } else if (state.ui.activeView === 'list') {
                        app.renderListCard(table);
                    }
                    // Tree view doesn't have tabs currently
                } 
            },
            changeSqlDialect: (dialect) => {
                state.ui.sqlDialect = dialect;
                app.saveState();
                
                // Check if expand modal is open and update it
                const modalBackdrop = document.getElementById('expand-modal-backdrop');
                if (modalBackdrop && !modalBackdrop.classList.contains('hidden')) {
                    // Modal is open, get the current table ID from the modal title or body
                    const modalBody = document.getElementById('expand-modal-body');
                    if (modalBody) {
                        // Find which table's data is being displayed by checking for a data attribute we can add
                        const tableId = modalBody.getAttribute('data-table-id');
                        if (tableId) {
                            app.openExpandModal(tableId);
                        }
                    }
                }
                
                // Re-render based on active view
                if (state.ui.activeView === 'board') {
                    app.renderAll();
                } else if (state.ui.activeView === 'list') {
                    app.renderListView();
                } else if (state.ui.activeView === 'tree') {
                    app.renderTreeView();
                }
            },
            toggleRelationType: (relationId) => { const relation = state.relations.find(r => r.id === relationId); if (relation) { relation.type = relation.type === '1:n' ? '1:1' : '1:n'; app.saveState(); app.drawConnections(); } },
            highlightRelation: (relationId, isHover) => {
                const badge = document.querySelector(`[data-badge-relation-id="${relationId}"]`);
                const path = document.querySelector(`path[data-relation-id="${relationId}"]`);
                if (isHover) {
                    if (badge && !badge.classList.contains('badge-selected')) badge.classList.add('badge-hover');
                    if (path && !path.classList.contains('selected')) path.classList.add('connection-line-hover');
                } else {
                    if (badge) badge.classList.remove('badge-hover');
                    if (path) path.classList.remove('connection-line-hover');
                }
            },
            selectRelation: (relationId) => {
                if (state.ui.selectedRelation === relationId) {
                    state.ui.selectedRelation = null;
                } else {
                    state.ui.selectedRelation = relationId;
                }
                app.drawConnections();
            },
            deleteRelation: (relId) => {
                if(!confirm('Remove relation?')) return; const rel = state.relations.find(r => r.id === relId);
                if (rel) { const table = state.tables.find(t => t.id === rel.toTableId); if (table) { const field = table.fields.find(f => f.id === rel.fkFieldId); if (field) { field.isFk = false; app.renderTable(table); } } }
                state.relations = state.relations.filter(r => r.id !== relId); app.saveState(); app.drawConnections(); app.updateStats();
            },
            autoLayout: () => {
                const spacingX = 480; const spacingY = 120;
                const getTableHeight = (t) => {
                    const headerHeight = 52;
                    const tabsHeight = 44;
                    const fieldHeight = 42;
                    const footerHeight = 56;
                    const enumPadding = t.fields.some(f => f.type === 'ENUM' && f.enumValues) ? 40 : 0;
                    return headerHeight + tabsHeight + (t.fields.length * fieldHeight) + footerHeight + enumPadding + 20;
                };
                const adj = {}; const revAdj = {};
                state.tables.forEach(t => { adj[t.id] = []; revAdj[t.id] = []; });
                state.relations.forEach(r => { if(adj[r.fromTableId]) adj[r.fromTableId].push(r.toTableId); if(revAdj[r.toTableId]) revAdj[r.toTableId].push(r.fromTableId); });
                const nodeLevels = {}; state.tables.forEach(t => nodeLevels[t.id] = 0);
                let changed = true; let iterations = 0;
                while(changed && iterations < state.tables.length + 2) {
                    changed = false;
                    state.relations.forEach(r => { if (nodeLevels[r.toTableId] < nodeLevels[r.fromTableId] + 1) { nodeLevels[r.toTableId] = nodeLevels[r.fromTableId] + 1; changed = true; } });
                    iterations++;
                }
                const levelGroups = []; Object.entries(nodeLevels).forEach(([id, lvl]) => { if (!levelGroups[lvl]) levelGroups[lvl] = []; levelGroups[lvl].push(id); });
                const finalPositions = {}; const occupied = {};
                state.tables.forEach(t => { finalPositions[t.id] = { x: (nodeLevels[t.id] || 0) * spacingX + 50, y: 0 }; });
                const maxLevel = levelGroups.length - 1;
                for (let l = 0; l <= maxLevel; l++) {
                    if (!levelGroups[l]) continue; occupied[l] = [];
                    if (l > 0) {
                        levelGroups[l].sort((aId, bId) => {
                            const getAvgParentY = (nodeId) => {
                                const parents = revAdj[nodeId]; if (parents.length === 0) return 0;
                                const sum = parents.reduce((acc, pid) => { const pPos = finalPositions[pid]; const pTable = state.tables.find(pt => pt.id === pid); return acc + pPos.y + (getTableHeight(pTable) / 2); }, 0);
                                return sum / parents.length;
                            };
                            return getAvgParentY(aId) - getAvgParentY(bId);
                        });
                    }
                    levelGroups[l].forEach(tId => {
                        const table = state.tables.find(t => t.id === tId); const height = getTableHeight(table);
                        let desiredCenterY = 0; const parents = revAdj[tId];
                        if (parents.length > 0) {
                            const parentCenters = parents.map(p => { const pPos = finalPositions[p]; const pTable = state.tables.find(pt => pt.id === p); return pPos.y + (getTableHeight(pTable) / 2); });
                            desiredCenterY = parentCenters.reduce((a,b)=>a+b,0) / parentCenters.length;
                        } else { desiredCenterY = 100; }
                        let desiredTop = desiredCenterY - (height / 2); let safeTop = desiredTop;
                        if (occupied[l].length > 0) { const previousItem = occupied[l][occupied[l].length - 1]; if (safeTop < previousItem.bottom + spacingY) { safeTop = previousItem.bottom + spacingY; } }
                        if (safeTop < 50) safeTop = 50; finalPositions[tId].y = safeTop; occupied[l].push({ top: safeTop, bottom: safeTop + height });
                    });
                }
                state.tables.forEach(t => { if (finalPositions[t.id]) { t.x = finalPositions[t.id].x; t.y = finalPositions[t.id].y; } });
                state.view.x = 50; state.view.y = 50; app.saveState(); app.updateCanvasTransform(); app.renderAll(); 
            },
            dragFieldStart: (e, tableId, index) => { e.stopPropagation(); state.ui.draggingField = { tableId, index }; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', JSON.stringify({ tableId, index })); requestAnimationFrame(() => { const row = e.target.closest('.field-row-container'); if (row) row.classList.add('dragging-row'); }); },
            dragFieldEnd: (e, tableId) => { document.querySelectorAll('.dragging-row').forEach(el => el.classList.remove('dragging-row')); state.ui.draggingField = null; },
            dragFieldOver: (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; },
            dropField: (e, targetTableId, targetIndex) => {
                e.stopPropagation(); e.preventDefault(); const source = state.ui.draggingField; if (!source) return;
                const sourceTable = state.tables.find(t => t.id === source.tableId); const targetTable = state.tables.find(t => t.id === targetTableId); if (!sourceTable || !targetTable) return;
                const [movedField] = sourceTable.fields.splice(source.index, 1);
                if (typeof targetIndex !== 'undefined') { targetTable.fields.splice(targetIndex, 0, movedField); } else { targetTable.fields.push(movedField); }
                app.saveState(); app.renderTable(sourceTable); if (source.tableId !== targetTableId) { app.renderTable(targetTable); } state.ui.draggingField = null;
            },
            dropFieldOnContainer: (e, targetTableId) => { e.preventDefault(); app.dropField(e, targetTableId); },
            updateCanvasTransform: () => { const world = document.getElementById('canvas-world'); const container = document.getElementById('canvas-container'); world.style.transform = `translate(${state.view.x}px, ${state.view.y}px) scale(${state.view.scale})`; const gridSize = 20 * state.view.scale; container.style.backgroundSize = `${gridSize}px ${gridSize}px`; container.style.backgroundPosition = `${state.view.x}px ${state.view.y}px`; },
            resetView: () => { state.view = { x: 0, y: 0, scale: 1 }; app.saveState(); app.updateCanvasTransform(); },
            zoomIn: () => { state.view.scale = Math.min(state.view.scale * 1.2, 3); app.saveState(); app.updateCanvasTransform(); },
            zoomOut: () => { state.view.scale = Math.max(state.view.scale * 0.8, 0.2); app.saveState(); app.updateCanvasTransform(); },
            openModal: () => { const backdrop = document.getElementById('modal-backdrop'); const content = document.getElementById('modal-content'); backdrop.classList.remove('hidden'); setTimeout(() => { backdrop.classList.remove('opacity-0'); content.classList.remove('scale-95'); content.classList.add('scale-100'); }, 10); document.getElementById('new-table-name').focus(); },
            closeModal: () => { const backdrop = document.getElementById('modal-backdrop'); const content = document.getElementById('modal-content'); backdrop.classList.add('opacity-0'); content.classList.remove('scale-100'); content.classList.add('scale-95'); setTimeout(() => { backdrop.classList.add('hidden'); }, 200); },
            startConnectionDrag: (e, id) => { e.stopPropagation(); e.preventDefault(); state.ui.connectingFrom = id; state.ui.showConnectionLine = false; app.updateUI(); },
            enableConnectionLine: (id) => { if (state.ui.connectingFrom === id) { state.ui.showConnectionLine = true; app.drawConnections(); } },
            cancelConnection: () => { state.ui.connectingFrom = null; state.ui.showConnectionLine = false; app.updateUI(); },
            completeConnection: (targetId) => {
                const sourceId = state.ui.connectingFrom; if (!sourceId || sourceId === targetId) return;
                const exists = state.relations.find(r => r.fromTableId === sourceId && r.toTableId === targetId); if (exists) { app.cancelConnection(); return; }
                const sourceTable = state.tables.find(t => t.id === sourceId); const targetTable = state.tables.find(t => t.id === targetId);
                const fieldName = `${app.getSingular(sourceTable.name)}_id`; let field = targetTable.fields.find(f => f.name === fieldName); let fieldId;
                if (!field) { fieldId = app.generateId(); targetTable.fields.push({ id: fieldId, name: fieldName, type: 'foreignId', isPk: false, isNullable: true, isFk: true }); app.renderTable(targetTable); } else { fieldId = field.id; if(!field.isFk) { field.isFk = true; app.renderTable(targetTable); } }
                state.relations.push({ id: app.generateId(), fromTableId: sourceId, toTableId: targetId, type: '1:n', fkFieldId: fieldId });
                app.saveState(); app.cancelConnection(); app.drawConnections(); 
            },
            updateStats: () => { document.getElementById('stats-display').innerHTML = `<b>${state.tables.length}</b> tables &bull; <b>${state.relations.length}</b> relations`; },
            updateUI: () => {
                const feedback = document.getElementById('connection-feedback');
                if (state.ui.connectingFrom) {
                    feedback.classList.remove('hidden'); document.querySelectorAll('.table-card').forEach(el => el.classList.remove('ring-4', 'ring-indigo-300')); document.getElementById(state.ui.connectingFrom)?.classList.add('ring-4', 'ring-indigo-300');
                } else { feedback.classList.add('hidden'); document.querySelectorAll('.table-card').forEach(el => el.classList.remove('ring-4', 'ring-indigo-300')); }
                app.drawConnections();
            },
            getAnchorPoint: (tableId, fieldId, side) => {
                const tableEl = document.getElementById(tableId); if (!tableEl) return { x: 0, y: 0 }; 
                let targetEl = null; if (fieldId) { targetEl = tableEl.querySelector(`[data-field-id="${fieldId}"]`); } if (!targetEl) { targetEl = tableEl.querySelector('.table-header'); }
                if (!targetEl) return { x: 0, y: 0 }; const rect = targetEl.getBoundingClientRect(); const container = document.getElementById('canvas-container').getBoundingClientRect();
                const centerY = (rect.top + rect.height / 2 - container.top - state.view.y) / state.view.scale;
                const x = side === 'left' ? (rect.left - container.left - state.view.x) / state.view.scale : (rect.right - container.left - state.view.x) / state.view.scale;
                return { x, y: centerY };
            },
            calculateSmartPath: (x1, y1, s1, x2, y2, s2) => {
                const stub = 20; const sx1 = s1 === 'right' ? x1 + stub : x1 - stub; const sx2 = s2 === 'right' ? x2 + stub : x2 - stub;
                const dx = Math.abs(sx2 - sx1); const controlX = Math.max(dx * 0.5, 60); 
                const cx1 = s1 === 'right' ? sx1 + controlX : sx1 - controlX; const cx2 = s2 === 'right' ? sx2 + controlX : sx2 - controlX;
                return `M ${x1} ${y1} L ${sx1} ${y1} C ${cx1} ${y1}, ${cx2} ${y2}, ${sx2} ${y2} L ${x2} ${y2}`;
            },
            calculateBezierMidpoint: (x1, y1, cx1, cy1, cx2, cy2, x2, y2) => {
                const t = 0.5; const mt = 1 - t; const mt2 = mt * mt; const mt3 = mt2 * mt; const t2 = t * t; const t3 = t2 * t;
                const x = (mt3 * x1) + (3 * mt2 * t * cx1) + (3 * mt * t2 * cx2) + (t3 * x2); const y = (mt3 * y1) + (3 * mt2 * t * cy1) + (3 * mt * t2 * cy2) + (t3 * y2);
                return { x, y };
            },
            drawConnections: () => {
                const svg = document.getElementById('connections-layer'); const labelsLayer = document.getElementById('labels-layer');
                let svgHtml = `<defs> <marker id="marker-one" markerWidth="10" markerHeight="10" refX="0" refY="5" orient="auto" markerUnits="strokeWidth"><path d="M0,0 L0,10 M0,5 L3,5" stroke="#94a3b8" stroke-width="1.5" fill="none" stroke-linecap="round"/></marker> <marker id="marker-many" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto" markerUnits="strokeWidth"><path d="M0,5 L8,5 M8,0 L0,5 L8,10" stroke="#94a3b8" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></marker> <marker id="marker-one-end" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto" markerUnits="strokeWidth"><path d="M8,0 L8,10 M0,5 L8,5" stroke="#94a3b8" stroke-width="1.5" fill="none" stroke-linecap="round"/></marker> <marker id="marker-arrow" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto" markerUnits="strokeWidth"><path d="M0,0 L8,4 L0,8 L2,4 Z" fill="#6366f1" /></marker> </defs>`;
                let labelsHtml = '';
                state.relations.forEach(rel => {
                    const fromT = state.tables.find(t => t.id === rel.fromTableId); const toT = state.tables.find(t => t.id === rel.toTableId);
                    if (fromT && toT) {
                        const c1 = { x: fromT.x + 144, y: fromT.y }; const c2 = { x: toT.x + 144, y: toT.y };
                        let startSide = 'right'; let endSide = 'left'; if (c2.x < c1.x) { startSide = 'left'; endSide = 'right'; }
                        const pkField = fromT.fields.find(f => f.isPk);
                        const start = app.getAnchorPoint(fromT.id, pkField?.id, startSide); const end = app.getAnchorPoint(toT.id, rel.fkFieldId, endSide);
                        const pathD = app.calculateSmartPath(start.x, start.y, startSide, end.x, end.y, endSide);
                        const markerStart = "url(#marker-one)"; const markerEnd = rel.type === '1:1' ? "url(#marker-one-end)" : "url(#marker-many)";
                        const relationTooltip = `${fromT.name} â ${toT.name}`;
                        const isSelected = state.ui.selectedRelation === rel.id;
                        const selectedClass = isSelected ? ' selected' : '';
                        svgHtml += `<path data-relation-id="${rel.id}" d="${pathD}" stroke="#94a3b8" stroke-width="2" fill="none" class="connection-line${selectedClass}" marker-start="${markerStart}" marker-end="${markerEnd}" style="pointer-events: stroke; cursor: pointer;" onclick="app.selectRelation('${rel.id}')" onmouseover="app.highlightRelation('${rel.id}', true)" onmouseout="app.highlightRelation('${rel.id}', false)"><title>${relationTooltip}</title></path>`;
                        const stub = 20; const sx1 = startSide === 'right' ? start.x + stub : start.x - stub; const sx2 = endSide === 'right' ? end.x + stub : end.x - stub;
                        const dx = Math.abs(sx2 - sx1); const controlX = Math.max(dx * 0.5, 60); const cx1 = startSide === 'right' ? sx1 + controlX : sx1 - controlX; const cx2 = endSide === 'right' ? sx2 + controlX : sx2 - controlX;
                        const mid = app.calculateBezierMidpoint(sx1, start.y, cx1, start.y, cx2, end.y, sx2, end.y); const badgeColor = rel.type === '1:1' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-blue-100 text-blue-700 border-blue-200';
                        const badgeSelectedClass = isSelected ? ' badge-selected' : '';
                        labelsHtml += `<div data-badge-relation-id="${rel.id}" class="relation-badge absolute flex items-center gap-1 text-[10px] font-bold px-1.5 py-0.5 rounded-full border shadow-sm ${badgeColor}${badgeSelectedClass} select-none pointer-events-auto" style="left: ${mid.x}px; top: ${mid.y}px; transform: translate(-50%, -50%);" onmouseover="app.highlightRelation('${rel.id}', true)" onmouseout="app.highlightRelation('${rel.id}', false)"> <span onclick="app.toggleRelationType('${rel.id}')" title="Toggle Type">${rel.type === '1:1' ? '1:1' : '1:N'}</span> <span onclick="app.deleteRelation('${rel.id}')" class="hover:text-red-600 cursor-pointer" title="Remove Relation">&times;</span> </div>`;
                    }
                });
                if (state.ui.connectingFrom && state.ui.showConnectionLine) {
                    const fromT = state.tables.find(t => t.id === state.ui.connectingFrom);
                    if (fromT) {
                        const pkField = fromT.fields.find(f => f.isPk);
                        const start = app.getAnchorPoint(fromT.id, pkField?.id, 'right');
                        const pathD = `M ${start.x} ${start.y} L ${state.ui.mousePos.x} ${state.ui.mousePos.y}`;
                        svgHtml += `<path d="${pathD}" stroke="#6366f1" stroke-width="2" fill="none" class="connection-line-active" marker-end="url(#marker-arrow)" />`;
                    }
                }
                svg.innerHTML = svgHtml; labelsLayer.innerHTML = labelsHtml;
            },
            renderAll: () => {
                const layer = document.getElementById('nodes-layer'); layer.innerHTML = '';
                state.tables.forEach(table => {
                    const div = document.createElement('div'); div.id = table.id;
                    div.className = `table-card absolute flex flex-col w-72 bg-white rounded-xl shadow-[0_8px_30px_rgb(0,0,0,0.12)] border border-slate-200 transition-all hover:shadow-[0_20px_40px_rgb(0,0,0,0.2)] hover:-translate-y-1`;
                    div.style.transform = `translate(${table.x}px, ${table.y}px)`;
                    layer.appendChild(div); app.renderTable(table);
                });
                app.updateStats();
                // Defer drawConnections to ensure DOM is fully rendered
                requestAnimationFrame(() => {
                    app.drawConnections();
                });
            },
            renderTable: (table) => {
                const el = document.getElementById(table.id); if (!el) return;
                const baseColor = table.color.split('-')[1]; const headerBg = `bg-${baseColor}-600`;
                let titleContent = `<div class="font-bold text-white text-sm pointer-events-auto cursor-text truncate tracking-wide" ondblclick="app.enableRename('${table.id}')" title="Double click to rename">${table.name}</div>`;
                if (state.ui.renamingTableId === table.id) {
                    titleContent = `<input type="text" value="${table.name}" class="w-full bg-white/10 text-white placeholder-white/50 border border-white/30 rounded px-1.5 py-0.5 text-sm font-bold outline-none focus:bg-white/20 focus:border-white" onblur="app.finishRename('${table.id}', this.value)" onkeydown="if(event.key === 'Enter') app.finishRename('${table.id}', this.value)" autoFocus >`;
                    setTimeout(() => { const input = el.querySelector('input[type="text"]'); if(input) { input.focus(); input.select(); } }, 10);
                }
                const headerHtml = `<div class="table-header flex items-center justify-between p-3 ${headerBg} cursor-grab active:cursor-grabbing rounded-t-xl select-none group relative overflow-hidden" onmousedown="app.startDragTable(event, '${table.id}')"> <div class="absolute inset-0 bg-gradient-to-tr from-black/5 to-transparent pointer-events-none"></div> <div class="flex items-center gap-2 flex-1 mr-2 relative z-10"> <i data-lucide="table-2" class="w-4 h-4 text-white/70"></i> ${titleContent} </div> <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity relative z-10"> <button onclick="event.stopPropagation(); app.openExpandModal('${table.id}')" class="p-1.5 rounded bg-white/10 hover:bg-white/20 text-white/90 transition-colors backdrop-blur-sm shadow-sm" title="Expand View"> <i data-lucide="maximize-2" class="w-3 h-3"></i> </button> <button onmousedown="app.startConnectionDrag(event, '${table.id}')" class="p-1.5 rounded bg-white/10 hover:bg-white/20 text-white/90 transition-colors backdrop-blur-sm shadow-sm" title="Drag to Connect"> <i data-lucide="link" class="w-3 h-3"></i> </button> <button onclick="event.stopPropagation(); app.deleteTable('${table.id}')" class="p-1.5 rounded bg-white/10 hover:bg-rose-500 text-white/90 hover:text-white transition-colors backdrop-blur-sm shadow-sm" title="Delete Table"> <i data-lucide="trash-2" class="w-3 h-3"></i> </button> </div> </div>`;
                const tabsHtml = `<div class="flex text-[11px] font-semibold border-b border-slate-100 bg-white"> <button onclick="app.setTab('${table.id}', 'fields')" class="flex-1 py-2.5 text-center transition-colors relative ${table.activeTab === 'fields' ? `text-${baseColor}-600 bg-${baseColor}-50/50` : 'text-slate-400 hover:text-slate-600 hover:bg-slate-50'}"> Structure ${table.activeTab === 'fields' ? `<span class="absolute bottom-0 left-0 w-full h-[2px] bg-${baseColor}-600"></span>` : ''} </button> <button onclick="app.setTab('${table.id}', 'sql')" class="flex-1 py-2.5 text-center transition-colors relative ${table.activeTab === 'sql' ? `text-${baseColor}-600 bg-${baseColor}-50/50` : 'text-slate-400 hover:text-slate-600 hover:bg-slate-50'}"> SQL ${table.activeTab === 'sql' ? `<span class="absolute bottom-0 left-0 w-full h-[2px] bg-${baseColor}-600"></span>` : ''} </button> <button onclick="app.setTab('${table.id}', 'laravel')" class="flex-1 py-2.5 text-center transition-colors relative ${table.activeTab === 'laravel' ? `text-${baseColor}-600 bg-${baseColor}-50/50` : 'text-slate-400 hover:text-slate-600 hover:bg-slate-50'}"> Laravel ${table.activeTab === 'laravel' ? `<span class="absolute bottom-0 left-0 w-full h-[2px] bg-${baseColor}-600"></span>` : ''} </button> </div>`;
                let contentHtml = '';
                if (table.activeTab === 'fields') {
                    const fieldsHtml = table.fields.map((f, index) => {
                        let enumHtml = '';
                        if (f.type === 'ENUM') {
                            const raw = f.enumValues ? f.enumValues.split(',') : []; const tags = raw.map(v => v.trim().replace(/^['"]|['"]$/g, '')).filter(v => v);
                            enumHtml = `<div class="pl-8 pr-2 pb-2 flex flex-wrap gap-1 items-center mt-1"> ${tags.map(tag => `<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded-md bg-slate-100 text-slate-600 text-[10px] border border-slate-200 font-medium group/tag"> ${tag} <button onclick="app.removeEnumVal('${table.id}', '${f.id}', '${tag}')" onmousedown="event.stopPropagation()" class="hover:text-rose-500 flex items-center justify-center w-3 h-3 rounded-full hover:bg-slate-200 text-xs font-bold leading-none transition-colors">&times;</button> </span>`).join('')} <input type="text" data-enum-input="${f.id}" placeholder="+ value" onkeydown="if(event.key === 'Enter') { app.addEnumVal('${table.id}', '${f.id}', this.value); }" onmousedown="event.stopPropagation()" class="flex-1 min-w-[50px] bg-transparent text-[10px] px-1.5 py-0.5 rounded border border-dashed border-slate-300 hover:border-${baseColor}-400 focus:border-${baseColor}-500 outline-none text-slate-600 placeholder:text-slate-400 transition-colors" > </div>`;
                        }
                        return `<div draggable="true" data-field-id="${f.id}" ondragstart="app.dragFieldStart(event, '${table.id}', ${index})" ondragover="app.dragFieldOver(event)" ondrop="app.dropField(event, '${table.id}', ${index})" ondragend="app.dragFieldEnd(event, '${table.id}')" class="field-row-container group flex flex-col relative transition-all border-b border-slate-50 last:border-0 hover:bg-slate-50/80"> <div class="flex items-center gap-2 p-2"> <div class="cursor-move text-slate-300 hover:text-slate-500 opacity-0 group-hover:opacity-100 transition-opacity"> <i data-lucide="grip-vertical" class="w-3 h-3"></i> </div> <div class="w-5 flex justify-center shrink-0"> ${f.isPk ? `<i data-lucide="key" class="w-3.5 h-3.5 text-amber-500 fill-amber-500/20" title="Primary Key"></i>` : ''} ${f.isFk ? `<i data-lucide="link-2" class="w-3.5 h-3.5 text-blue-500" title="Foreign Key"></i>` : ''} ${!f.isPk && !f.isFk ? `<div class="w-1.5 h-1.5 rounded-full bg-slate-200"></div>` : ''} </div> <input type="text" value="${f.name}" onmousedown="event.stopPropagation()" onchange="app.updateField('${table.id}', '${f.id}', 'name', this.value)" class="flex-1 bg-transparent outline-none font-mono text-[13px] text-slate-700 min-w-0 placeholder:text-slate-300 focus:text-${baseColor}-600 font-medium transition-colors"> <div class="relative group/select"> <select onmousedown="event.stopPropagation()" onchange="app.updateField('${table.id}', '${f.id}', 'type', this.value)" class="appearance-none bg-slate-100 hover:bg-slate-200 text-[10px] text-slate-600 font-bold py-1 px-2 pr-6 rounded-md outline-none cursor-pointer transition-colors border border-transparent focus:border-${baseColor}-300 uppercase tracking-wide"> ${CONSTANTS.DATA_TYPES.map(t => `<option value="${t}" ${f.type === t ? 'selected' : ''}>${t}</option>`).join('')} </select> <i data-lucide="chevron-down" class="absolute right-1.5 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none"></i> </div> <button onmousedown="event.stopPropagation()" onclick="app.toggleFieldProp('${table.id}', '${f.id}', 'isNullable')" class="px-1.5 py-0.5 rounded text-[9px] font-bold border transition-colors ${f.isNullable ? 'bg-indigo-100 text-indigo-600 border-indigo-200' : 'bg-transparent text-slate-300 border-transparent hover:bg-slate-100 hover:text-slate-50'}" title="Toggle Nullable" ${f.isPk ? 'disabled style="opacity:0.3"' : ''}>N</button> <button onmousedown="event.stopPropagation()" onclick="app.removeField('${table.id}', '${f.id}')" class="opacity-0 group-hover:opacity-100 p-1 text-slate-300 hover:text-rose-500 transition-colors"> <i data-lucide="x" class="w-3.5 h-3.5"></i> </button> </div> ${enumHtml} </div>`;
                    }).join('');
                    contentHtml = `<div class="flex flex-col py-1 bg-white min-h-[50px] rounded-b-xl" ondragover="app.dragFieldOver(event)" ondrop="app.dropFieldOnContainer(event, '${table.id}')"> ${fieldsHtml} <div class="px-2 pt-2 pb-2"> <button onclick="app.addField('${table.id}')" class="w-full flex items-center justify-center gap-2 text-xs font-semibold text-slate-400 hover:text-${baseColor}-600 hover:bg-${baseColor}-50 p-2 rounded-lg transition-all border border-dashed border-slate-200 hover:border-${baseColor}-200"> <i data-lucide="plus" class="w-3.5 h-3.5"></i> <span>Add Field</span> </button> </div> </div>`;
                } else if (table.activeTab === 'sql') {
                    contentHtml = `<div class="p-0 bg-slate-50/50 rounded-b-xl overflow-hidden h-full flex flex-col"> <div class="px-2 pt-2 pb-1 border-b border-slate-100 bg-white flex items-center justify-between"> <span class="text-[10px] text-slate-500 font-semibold">Database:</span> <div class="relative"> <select onchange="app.changeSqlDialect(this.value)" class="appearance-none bg-slate-100 hover:bg-slate-200 text-[10px] text-slate-700 font-semibold py-1 px-2 pr-6 rounded-md outline-none cursor-pointer transition-colors border border-slate-200"> <option value="mysql" ${state.ui.sqlDialect === 'mysql' ? 'selected' : ''}>MySQL</option> <option value="postgresql" ${state.ui.sqlDialect === 'postgresql' ? 'selected' : ''}>PostgreSQL</option> <option value="sqlite" ${state.ui.sqlDialect === 'sqlite' ? 'selected' : ''}>SQLite</option> <option value="sqlserver" ${state.ui.sqlDialect === 'sqlserver' ? 'selected' : ''}>SQL Server</option> </select> <i data-lucide="chevron-down" class="absolute right-1 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-500 pointer-events-none"></i> </div> </div> <div class="overflow-auto max-h-64 p-3 custom-scrollbar"> <pre class="code-block text-slate-600 text-xs">${generators.sql(table)}</pre> </div> <div class="p-2 border-t border-slate-100 bg-white"> <button onclick="app.copyToClipboard(generators.sql(state.tables.find(t=>t.id=='${table.id}')))" class="w-full flex items-center justify-center gap-2 text-xs font-semibold bg-slate-100 hover:bg-slate-200 text-slate-600 py-2 rounded-lg transition-colors"> <i data-lucide="copy" class="w-3 h-3"></i> Copy SQL </button> </div> </div>`;
                } else if (table.activeTab === 'laravel') {
                    contentHtml = `<div class="p-0 bg-slate-50/50 rounded-b-xl overflow-hidden h-full flex flex-col"> <div class="overflow-auto max-h-64 p-3 custom-scrollbar"> <pre class="code-block text-indigo-600 text-xs">${generators.laravel(table)}</pre> </div> <div class="p-2 border-t border-slate-100 bg-white"> <button onclick="app.copyToClipboard(generators.laravel(state.tables.find(t=>t.id=='${table.id}')))" class="w-full flex items-center justify-center gap-2 text-xs font-semibold bg-slate-100 hover:bg-slate-200 text-slate-600 py-2 rounded-lg transition-colors"> <i data-lucide="copy" class="w-3 h-3"></i> Copy Migration </button> </div> </div>`;
                }
                el.innerHTML = headerHtml + tabsHtml + contentHtml;
                lucide.createIcons({ root: el });
                el.onmouseup = (e) => { if (state.ui.connectingFrom && state.ui.connectingFrom !== table.id) { e.stopPropagation(); app.completeConnection(table.id); } };
                el.onmouseleave = (e) => { if (state.ui.connectingFrom === table.id && !state.ui.showConnectionLine) { app.enableConnectionLine(table.id); } };
            },
            toggleFieldProp: (tableId, fieldId, prop) => {
                const table = state.tables.find(t => t.id === tableId);
                const field = table.fields.find(f => f.id === fieldId);
                if (field) {
                    if (prop === 'isNullable' && field.isPk) return;
                    field[prop] = !field[prop];
                    app.saveState();
                    if (state.ui.activeView === 'board') app.renderTable(table);
                    else app.renderListCard(table);
                }
            },
            updateTablePosition: (tId, newX, newY) => {
                const el = document.getElementById(tId);
                if(el) {
                    el.style.transform = `translate(${newX}px, ${newY}px)`;
                }
            },
            startDragTable: (e, id) => { if(e.target.closest('button') || e.target.closest('input') || e.target.closest('select')) return; e.preventDefault(); e.stopPropagation(); const table = state.tables.find(t => t.id === id); const el = document.getElementById(id); if(el) el.classList.add('dragging-table'); state.ui.draggingTable = { id: id, offsetX: e.clientX - (table.x * state.view.scale) - state.view.x, offsetY: e.clientY - (table.y * state.view.scale) - state.view.y }; },
            attachListeners: () => {
                const canvas = document.getElementById('canvas-container');
                let lastMouseEvent = null;

                canvas.addEventListener('mousedown', (e) => { if (e.target === canvas || e.target.id === 'connections-layer' || e.target.id === 'nodes-layer' || e.target.id === 'labels-layer') { state.ui.isDraggingCanvas = true; state.ui.dragStart = { x: e.clientX - state.view.x, y: e.clientY - state.view.y }; canvas.style.cursor = 'grabbing'; } });
                
                const handleMouseMove = () => {
                    if (!lastMouseEvent) return;
                    const e = lastMouseEvent;
                    const rect = canvas.getBoundingClientRect();
                    state.ui.mousePos = { x: (e.clientX - rect.left - state.view.x) / state.view.scale, y: (e.clientY - rect.top - state.view.y) / state.view.scale };
                    
                    if (state.ui.isDraggingCanvas) {
                        state.view.x = e.clientX - state.ui.dragStart.x;
                        state.view.y = e.clientY - state.ui.dragStart.y;
                        app.updateCanvasTransform();
                    }
                    
                    if (state.ui.draggingTable) {
                        const tId = state.ui.draggingTable.id;
                        const table = state.tables.find(t => t.id === tId);
                        table.x = (e.clientX - state.ui.draggingTable.offsetX - state.view.x) / state.view.scale;
                        table.y = (e.clientY - state.ui.draggingTable.offsetY - state.view.y) / state.view.scale;
                        app.updateTablePosition(tId, table.x, table.y);
                        app.drawConnections();
                    }
                    
                    if (state.ui.connectingFrom) {
                        app.drawConnections();
                    }
                    
                    lastMouseEvent = null;
                    state.ui.animationFrameId = null;
                };

                window.addEventListener('mousemove', (e) => {
                    lastMouseEvent = e;
                    if (!state.ui.animationFrameId && (state.ui.isDraggingCanvas || state.ui.draggingTable || state.ui.connectingFrom)) {
                        state.ui.animationFrameId = requestAnimationFrame(handleMouseMove);
                    }
                });
                
                window.addEventListener('mouseup', () => {
                    if (state.ui.isDraggingCanvas) { app.saveState(); }
                    if (state.ui.draggingTable) {
                        const el = document.getElementById(state.ui.draggingTable.id);
                        if(el) el.classList.remove('dragging-table');
                        app.saveState();
                    }
                    state.ui.isDraggingCanvas = false;
                    state.ui.draggingTable = null;
                    canvas.style.cursor = 'grab';
                    if (state.ui.connectingFrom) { app.cancelConnection(); }
                    if (state.ui.animationFrameId) {
                        cancelAnimationFrame(state.ui.animationFrameId);
                        state.ui.animationFrameId = null;
                    }
                    lastMouseEvent = null;
                });
                
                canvas.addEventListener('wheel', (e) => { if (e.ctrlKey || e.metaKey) { e.preventDefault(); const s = e.deltaY > 0 ? 0.9 : 1.1; state.view.scale = Math.min(Math.max(0.2, state.view.scale * s), 3); app.updateCanvasTransform(); app.saveState(); } }, { passive: false });
            }
        };

        document.addEventListener('DOMContentLoaded', app.init);

    </script>
</body>
</html>